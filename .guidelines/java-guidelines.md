# Java Corporate Guidelines

**Tech Stack**: Java, Spring Boot, Backend Services, Microservices

**Auto-detected from**: `pom.xml`, `build.gradle`, or `*.java` files

## 1. Scaffolding

### Creating New Spring Boot Applications

**Corporate Command**:

```bash
npx @YOUR_ORG/create-spring-app <app-name> --template microservice
```

**Example**:

```bash
npx @acmecorp/create-spring-app user-service --template microservice
```

**Options**:

- `--template microservice` - Microservice template with service discovery
- `--template monolith` - Monolithic application template
- `--template batch` - Batch processing application
- `--with-security` - Include corporate security configuration
- `--with-monitoring` - Include observability stack

**DO NOT USE**:

```bash
# ❌ Public Spring Initializr - bypasses corporate configuration
curl https://start.spring.io/starter.zip \
  -d dependencies=web,data-jpa \
  -o my-app.zip
```

**Alternative** (if corporate CLI not available):

Use internal Spring Initializr: `https://spring-init.YOUR_DOMAIN.com`

### Project Structure

**Standard structure** (generated by corporate scaffolding):

```text
src/
├── main/
│   ├── java/
│   │   └── com/acmecorp/userservice/
│   │       ├── UserServiceApplication.java
│   │       ├── controller/
│   │       ├── service/
│   │       ├── repository/
│   │       ├── model/
│   │       ├── dto/
│   │       ├── config/
│   │       └── exception/
│   └── resources/
│       ├── application.yml
│       ├── application-dev.yml
│       ├── application-prod.yml
│       └── db/migration/          # Flyway migrations
└── test/
    └── java/
        └── com/acmecorp/userservice/
```

## 2. Package Registry

### Maven Configuration

**File**: `pom.xml`

**Corporate Repository**:

```xml
<repositories>
    <repository>
        <id>acmecorp-releases</id>
        <name>AcmeCorp Release Repository</name>
        <url>https://artifactory.acmecorp.com/artifactory/libs-release</url>
    </repository>
    <repository>
        <id>acmecorp-snapshots</id>
        <name>AcmeCorp Snapshot Repository</name>
        <url>https://artifactory.acmecorp.com/artifactory/libs-snapshot</url>
        <snapshots>
            <enabled>true</enabled>
        </snapshots>
    </repository>
</repositories>

<pluginRepositories>
    <pluginRepository>
        <id>acmecorp-plugins</id>
        <name>AcmeCorp Plugin Repository</name>
        <url>https://artifactory.acmecorp.com/artifactory/plugins-release</url>
    </pluginRepository>
</pluginRepositories>
```

**Distribution Management** (for publishing):

```xml
<distributionManagement>
    <repository>
        <id>acmecorp-releases</id>
        <url>https://artifactory.acmecorp.com/artifactory/libs-release-local</url>
    </repository>
    <snapshotRepository>
        <id>acmecorp-snapshots</id>
        <url>https://artifactory.acmecorp.com/artifactory/libs-snapshot-local</url>
    </snapshotRepository>
</distributionManagement>
```

### Gradle Configuration

**File**: `build.gradle`

```gradle
repositories {
    maven {
        url "https://artifactory.acmecorp.com/artifactory/libs-release"
        credentials {
            username = project.findProperty("artifactory.user") ?: System.getenv("ARTIFACTORY_USER")
            password = project.findProperty("artifactory.password") ?: System.getenv("ARTIFACTORY_PASSWORD")
        }
    }
}
```

### Authentication

**File**: `~/.m2/settings.xml`

```xml
<settings>
    <servers>
        <server>
            <id>acmecorp-releases</id>
            <username>${env.ARTIFACTORY_USER}</username>
            <password>${env.ARTIFACTORY_PASSWORD}</password>
        </server>
        <server>
            <id>acmecorp-snapshots</id>
            <username>${env.ARTIFACTORY_USER}</username>
            <password>${env.ARTIFACTORY_PASSWORD}</password>
        </server>
    </servers>
</settings>
```

**Environment variables**:

```bash
export ARTIFACTORY_USER=your-username
export ARTIFACTORY_PASSWORD=your-api-key
```

## 3. Mandatory Libraries

### Corporate Spring Boot Starter

**MUST USE**: Corporate Spring Boot starter with pre-configured dependencies

**Maven**:

```xml
<parent>
    <groupId>com.YOUR_ORG</groupId>
    <artifactId>acmecorp-spring-boot-starter-parent</artifactId>
    <version>2.1.0</version>
</parent>

<dependencies>
    <!-- Corporate starter includes: security, logging, monitoring, etc. -->
    <dependency>
        <groupId>com.YOUR_ORG</groupId>
        <artifactId>acmecorp-spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

**What it includes**:

- Corporate security configuration
- Centralized logging (structured JSON logs)
- Distributed tracing (OpenTelemetry)
- Health checks and metrics
- Standard exception handling
- CORS configuration
- Request/response logging

### Security & Authentication

**MUST USE**: Corporate security library

**Maven**:

```xml
<dependency>
    <groupId>com.YOUR_ORG</groupId>
    <artifactId>acmecorp-security-spring-boot-starter</artifactId>
    <version>3.2.0</version>
</dependency>
```

**Usage**:

```java
import com.acmecorp.security.annotation.SecuredEndpoint;
import com.acmecorp.security.context.SecurityContextHolder;
import com.acmecorp.security.model.User;

@RestController
@RequestMapping("/api/users")
public class UserController {

    @GetMapping
    @SecuredEndpoint(roles = {"USER", "ADMIN"})
    public List<UserDTO> getAllUsers() {
        // Corporate security library automatically validates JWT token
        // and populates security context
        User currentUser = SecurityContextHolder.getCurrentUser();
        return userService.getAllUsers(currentUser);
    }

    @PostMapping
    @SecuredEndpoint(roles = "ADMIN", auditLog = true)
    public UserDTO createUser(@RequestBody CreateUserRequest request) {
        // Audit logging automatically captured
        return userService.createUser(request);
    }
}
```

**Configuration** (`application.yml`):

```yaml
acmecorp:
  security:
    jwt:
      issuer: https://auth.acmecorp.com
      audience: acmecorp-services
      jwks-uri: https://auth.acmecorp.com/.well-known/jwks.json
    cors:
      allowed-origins:
        - https://app.acmecorp.com
      allowed-methods:
        - GET
        - POST
        - PUT
        - DELETE
```

### API Client SDK

**MUST USE**: Corporate API client for inter-service communication

**Maven**:

```xml
<dependency>
    <groupId>com.YOUR_ORG</groupId>
    <artifactId>acmecorp-api-client</artifactId>
    <version>1.8.0</version>
</dependency>
```

**Usage**:

```java
import com.acmecorp.client.ApiClient;
import com.acmecorp.client.annotation.CircuitBreaker;
import com.acmecorp.client.annotation.Retry;

@Service
public class UserService {

    private final ApiClient<OrderServiceClient> orderClient;

    public UserService(ApiClientFactory clientFactory) {
        this.orderClient = clientFactory.create(OrderServiceClient.class);
    }

    @CircuitBreaker(fallbackMethod = "getOrdersFallback")
    @Retry(maxAttempts = 3, backoff = @Backoff(delay = 1000))
    public List<Order> getUserOrders(String userId) {
        // Automatic service discovery, load balancing, and circuit breaking
        return orderClient.get().getOrdersByUserId(userId);
    }

    private List<Order> getOrdersFallback(String userId, Throwable t) {
        log.warn("Fallback triggered for getUserOrders", t);
        return Collections.emptyList();
    }
}
```

**Features**:

- Service discovery (Eureka, Consul)
- Load balancing (Ribbon, Spring Cloud LoadBalancer)
- Circuit breaker (Resilience4j)
- Automatic retry with exponential backoff
- Request/response logging and tracing
- Type-safe client generation from OpenAPI specs

### Database Access

**MUST USE**: Spring Data JPA with corporate conventions

**Maven**:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<dependency>
    <groupId>com.YOUR_ORG</groupId>
    <artifactId>acmecorp-jpa-extensions</artifactId>
    <version>1.3.0</version>
</dependency>
```

**Entity example**:

```java
import com.acmecorp.jpa.audit.AuditedEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;

import javax.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "users")
@Data
@EqualsAndHashCode(callSuper = true)
public class User extends AuditedEntity {  // Corporate base entity with audit fields

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true, length = 255)
    private String email;

    @Column(nullable = false)
    private String passwordHash;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserStatus status;

    // Audit fields inherited from AuditedEntity:
    // - createdAt
    // - createdBy
    // - updatedAt
    // - updatedBy
    // - version (optimistic locking)
}
```

**Repository**:

```java
import com.acmecorp.jpa.repository.BaseRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface UserRepository extends BaseRepository<User, Long> {  // Corporate base repository

    Optional<User> findByEmail(String email);

    @Query("SELECT u FROM User u WHERE u.status = 'ACTIVE' AND u.createdAt > :since")
    List<User> findActiveUsersSince(@Param("since") LocalDateTime since);
}
```

### Database Migration

**MUST USE**: Flyway for database migrations

**Maven**:

```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

**Migration files** (`src/main/resources/db/migration/`):

```text
V1__create_users_table.sql
V2__add_user_status.sql
V3__create_orders_table.sql
```

**Example migration**:

```sql
-- V1__create_users_table.sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(255),
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255),
    version INTEGER NOT NULL DEFAULT 0
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

### Logging (Mandatory)

**MUST USE**: Corporate logging library (SLF4J + Logback with JSON format)

**Already included** in corporate Spring Boot starter.

**Usage**:

```java
import lombok.extern.slf4j.Slf4j;
import com.acmecorp.logging.annotation.LogExecution;

@Service
@Slf4j
public class UserService {

    @LogExecution  // Automatic method entry/exit logging with duration
    public UserDTO createUser(CreateUserRequest request) {
        log.info("Creating user with email: {}", request.getEmail());

        try {
            User user = userRepository.save(toEntity(request));
            log.info("User created successfully with ID: {}", user.getId());
            return toDTO(user);
        } catch (Exception e) {
            log.error("Failed to create user", e);
            throw new UserCreationException("Failed to create user", e);
        }
    }
}
```

**Structured logging** (JSON output):

```json
{
  "timestamp": "2025-01-15T10:30:00.123Z",
  "level": "INFO",
  "thread": "http-nio-8080-exec-1",
  "logger": "com.acmecorp.userservice.UserService",
  "message": "Creating user with email: user@example.com",
  "traceId": "abc123def456",
  "spanId": "xyz789",
  "userId": "12345",
  "service": "user-service"
}
```

### Validation

**MUST USE**: Jakarta Bean Validation (JSR-380) with corporate validators

**Maven**:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>

<dependency>
    <groupId>com.YOUR_ORG</groupId>
    <artifactId>acmecorp-validators</artifactId>
    <version>1.1.0</version>
</dependency>
```

**Usage**:

```java
import javax.validation.constraints.*;
import com.acmecorp.validation.annotation.ValidCorporateEmail;
import lombok.Data;

@Data
public class CreateUserRequest {

    @NotBlank(message = "Email is required")
    @Email(message = "Email must be valid")
    @ValidCorporateEmail  // Custom corporate validator
    private String email;

    @NotBlank(message = "Password is required")
    @Size(min = 12, message = "Password must be at least 12 characters")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&]).*$",
             message = "Password must contain uppercase, lowercase, digit, and special character")
    private String password;

    @NotBlank(message = "First name is required")
    @Size(max = 100)
    private String firstName;

    @NotBlank(message = "Last name is required")
    @Size(max = 100)
    private String lastName;
}

@RestController
public class UserController {

    @PostMapping("/api/users")
    public ResponseEntity<UserDTO> createUser(@Valid @RequestBody CreateUserRequest request) {
        // Validation automatically applied by @Valid
        // Returns 400 Bad Request with validation errors if invalid
        return ResponseEntity.ok(userService.createUser(request));
    }
}
```

### Testing

**MUST USE**: JUnit 5 + Mockito + Spring Boot Test

**Maven**:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>com.YOUR_ORG</groupId>
    <artifactId>acmecorp-test-utilities</artifactId>
    <version>1.2.0</version>
    <scope>test</scope>
</dependency>
```

**Unit test example**:

```java
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserServiceTest {

    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private UserService userService;

    @Test
    void createUser_shouldSaveAndReturnUser() {
        // Given
        CreateUserRequest request = new CreateUserRequest("user@example.com", "password123");
        User savedUser = new User(1L, "user@example.com", "hash", UserStatus.ACTIVE);
        when(userRepository.save(any(User.class))).thenReturn(savedUser);

        // When
        UserDTO result = userService.createUser(request);

        // Then
        assertNotNull(result);
        assertEquals(1L, result.getId());
        assertEquals("user@example.com", result.getEmail());
        verify(userRepository, times(1)).save(any(User.class));
    }
}
```

**Integration test example**:

```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc
class UserControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void createUser_withValidData_shouldReturn201() throws Exception {
        String requestBody = """
            {
                "email": "user@example.com",
                "password": "SecurePassword123!",
                "firstName": "John",
                "lastName": "Doe"
            }
            """;

        mockMvc.perform(post("/api/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.email").value("user@example.com"));
    }
}
```

## 4. Banned Libraries

**DO NOT USE** the following libraries. Use corporate alternatives instead:

### HTTP Clients

❌ **BANNED**:

- Apache HttpClient (direct usage)
- OkHttp (direct usage)
- RestTemplate (deprecated)

✅ **USE INSTEAD**: `@YOUR_ORG/acmecorp-api-client` or WebClient (Spring WebFlux)

### Database Frameworks

❌ **RESTRICTED** (require justification):

- Hibernate without Spring Data JPA
- MyBatis (unless approved for legacy systems)
- JOOQ (unless approved for complex SQL)

✅ **PREFER**: Spring Data JPA with corporate extensions

### Logging (Banned)

❌ **BANNED**:

- Log4j 1.x (security vulnerabilities)
- java.util.logging (JUL)
- System.out.println for logging

✅ **USE**: SLF4J + Logback (included in corporate starter)

### JSON Processing

❌ **RESTRICTED**:

- Gson (prefer Jackson)
- org.json (prefer Jackson)

✅ **PREFER**: Jackson (included in Spring Boot)

## 5. Architecture Patterns

### Layered Architecture

**MUST** follow layered architecture:

```text
Controller Layer → Service Layer → Repository Layer → Database
     ↓                  ↓                ↓
   DTOs            Business Logic     Entities
```

**Controller**: REST endpoints, request/response mapping

```java
@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;

    @GetMapping("/{id}")
    public ResponseEntity<UserDTO> getUser(@PathVariable Long id) {
        return userService.findById(id)
                .map(ResponseEntity::ok)
                .orElse(ResponseEntity.notFound().build());
    }
}
```

**Service**: Business logic, transaction management

```java
@Service
@RequiredArgsConstructor
@Transactional
public class UserService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    public UserDTO createUser(CreateUserRequest request) {
        // Business logic here
        User user = new User();
        user.setEmail(request.getEmail());
        user.setPasswordHash(passwordEncoder.encode(request.getPassword()));
        user.setStatus(UserStatus.ACTIVE);

        User saved = userRepository.save(user);
        return toDTO(saved);
    }
}
```

**Repository**: Data access

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
}
```

### DTOs vs Entities

**MUST** separate DTOs from entities:

```java
// Entity (internal representation)
@Entity
public class User {
    private Long id;
    private String email;
    private String passwordHash;  // Never expose in API
    // ...
}

// DTO (API representation)
public record UserDTO(
    Long id,
    String email,
    String firstName,
    String lastName,
    LocalDateTime createdAt
) {}
```

### Exception Handling

**MUST** use centralized exception handling:

```java
import com.acmecorp.exception.ErrorResponse;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleResourceNotFound(ResourceNotFoundException ex) {
        ErrorResponse error = new ErrorResponse(
            "RESOURCE_NOT_FOUND",
            ex.getMessage(),
            LocalDateTime.now()
        );
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }

    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidation(ValidationException ex) {
        ErrorResponse error = new ErrorResponse(
            "VALIDATION_ERROR",
            ex.getMessage(),
            LocalDateTime.now(),
            ex.getErrors()  // Field-level errors
        );
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
}
```

## 6. Security & Compliance

### Input Validation

**ALWAYS** validate all inputs:

```java
@PostMapping("/api/users/{id}/role")
@SecuredEndpoint(roles = "ADMIN")
public ResponseEntity<Void> updateUserRole(
        @PathVariable @Positive Long id,
        @RequestBody @Valid UpdateRoleRequest request) {
    userService.updateRole(id, request.getRole());
    return ResponseEntity.ok().build();
}
```

### SQL Injection Prevention

**ALWAYS** use parameterized queries:

```java
// ✅ Good - parameterized query
@Query("SELECT u FROM User u WHERE u.email = :email AND u.status = :status")
Optional<User> findByEmailAndStatus(@Param("email") String email, @Param("status") UserStatus status);

// ❌ Bad - string concatenation (SQL injection risk)
@Query("SELECT u FROM User u WHERE u.email = '" + email + "'")  // NEVER DO THIS
```

### Secrets Management

**NEVER** hardcode secrets:

```java
// ❌ NEVER
private static final String API_KEY = "sk-12345-abcdef";

// ✅ DO THIS
@Value("${acmecorp.api.key}")
private String apiKey;
```

**Use corporate secrets manager** (AWS Secrets Manager, HashiCorp Vault):

```yaml
# application.yml
acmecorp:
  secrets:
    provider: aws-secrets-manager
    region: us-east-1
```

### Audit Logging

**MUST** log sensitive operations:

```java
@PostMapping("/api/users/{id}")
@SecuredEndpoint(roles = "ADMIN")
@AuditLog(action = "UPDATE_USER", resource = "User")
public ResponseEntity<UserDTO> updateUser(
        @PathVariable Long id,
        @RequestBody @Valid UpdateUserRequest request) {
    // Corporate library automatically logs: who, what, when
    return ResponseEntity.ok(userService.updateUser(id, request));
}
```

## 7. Coding Standards

### Java Version

**MUST** use Java 17 or later (LTS):

```xml
<properties>
    <java.version>17</java.version>
</properties>
```

### Lombok

**RECOMMENDED**: Use Lombok to reduce boilerplate

```java
import lombok.Data;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Service
@RequiredArgsConstructor
@Slf4j
public class UserService {

    private final UserRepository userRepository;

    // No need for constructor, logger field, etc.
}
```

### Naming Conventions

- **Classes**: PascalCase (`UserService`, `UserController`)
- **Methods**: camelCase (`createUser`, `findById`)
- **Constants**: UPPER_SNAKE_CASE (`MAX_RETRIES`, `API_VERSION`)
- **Packages**: lowercase (`com.acmecorp.userservice.controller`)

### Code Style

**MUST** follow Google Java Style Guide or corporate style guide.

**Use** code formatter (Maven plugin):

```xml
<plugin>
    <groupId>com.spotify.fmt</groupId>
    <artifactId>fmt-maven-plugin</artifactId>
    <version>2.21</version>
    <executions>
        <execution>
            <goals>
                <goal>format</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

## 8. Build & Deployment

### Maven Build

```bash
mvn clean install
```

### Docker

**Dockerfile** (multi-stage):

```dockerfile
# Build stage
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn clean package -DskipTests

# Runtime stage
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### Configuration

**Use profiles** for environments:

```yaml
# application.yml
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

---
# application-dev.yml
spring:
  config:
    activate:
      on-profile: dev
  datasource:
    url: jdbc:postgresql://localhost:5432/userdb

---
# application-prod.yml
spring:
  config:
    activate:
      on-profile: prod
  datasource:
    url: jdbc:postgresql://${DB_HOST}:5432/userdb
```

## 9. Performance

**MUST**:

- Use connection pooling (HikariCP - included in Spring Boot)
- Implement caching for frequently accessed data
- Use pagination for large result sets
- Optimize database queries (avoid N+1 queries)

## 10. Observability

**MUST** include:

- Health checks (`/actuator/health`)
- Metrics (`/actuator/metrics`)
- Distributed tracing (OpenTelemetry)
- Structured logging

**Included** in corporate Spring Boot starter.

## See Also

- `README.md` - Guidelines overview
- `branching-guidelines.md` - Branch naming conventions
- Internal developer portal for corporate library documentation
