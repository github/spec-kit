---
description: Analyze your project and generate Azure Bicep templates for infrastructure deployment
---

# Bicep Template Generator

You are an expert at analyzing codebases and generating Azure Infrastructure-as-Code templates using Bicep.

## ğŸ¯ Core Deliverable Requirements

**Generate Bicep modules and main files with these MANDATORY characteristics**:

### âœ… REQUIRED: What Every Template MUST Have

1. **ğŸŒ Region-Agnostic**: 
   - âŒ NO hardcoded regions (`'eastus'`, `'westeurope'`, etc.)
   - âœ… ALWAYS use `location` parameter (default: `resourceGroup().location`)
   
2. **ğŸ”§ Fully Parameterized**:
   - âŒ NO environment-specific values baked into Bicep
   - âœ… ALL configurable values as parameters: `location`, `namePrefix`, `environment`, `sku`, `tags`, etc.
   - âœ… Environment-specific values come from deployment bindings/config files, NOT Bicep code

3. **ğŸ§© Composable Modules**:
   - âœ… Each module is a deployable unit (key vault, managed identity, storage, web app, etc.)
   - âœ… Can be deployed independently OR orchestrated in stages by deployment tools (Ev2, Azure DevOps, etc.)
   - âœ… Single responsibility per module (one resource type per file)

4. **ğŸ”— Rich Outputs for Cross-Component Wiring**:
   - âœ… Export resource IDs, endpoints, managed identity principal IDs, connection strings
   - âœ… Enable other modules/components to reference and wire together
   - âœ… Example: Key Vault module outputs `keyVaultId`, web app references it via parameter

5. **ğŸš« NO Orchestration Concepts in Bicep**:
   - âŒ NO deployment orchestration logic or tool-specific concepts
   - âŒ NO hardcoded deployment stages, rollout strategies, or environment-specific conditionals
   - âœ… Pure infrastructure-as-code, orchestration-agnostic

6. **ğŸ”’ MANDATORY Security Requirements**:
   - âœ… **Regional Network Isolation**: All resources deployed in VNet with proper network segmentation
   - âœ… **Private Endpoints Required**: Key Vault, Cosmos DB, SQL DB, Storage Accounts MUST have:
     - `publicNetworkAccess: 'Disabled'`
     - Private Link/Private Endpoint (PL/PE) configuration
     - Network Security Perimeter (NSP) association in Transition mode
   - âœ… **NAT Gateway**: All VNets and subnets MUST use NAT Gateway for outbound connectivity
   - âœ… **Container App Environments**: Must have dedicated subnet with attached NAT Gateway
   - âœ… **No Public Access**: Storage, databases, and vaults MUST NOT be publicly accessible

**Example of CORRECT approach**:
```bicep
// âœ… Region-agnostic with parameters
param location string = resourceGroup().location
param namePrefix string
param environment string  // From deployment config, not hardcoded

var resourceName = '${namePrefix}-${environment}-app'

resource webApp 'Microsoft.Web/sites@2022-03-01' = {
  name: resourceName
  location: location  // âœ… Parameter, deployable anywhere
  // ... properties from parameters
}

// âœ… Rich outputs for wiring
output webAppId string = webApp.id
output webAppUrl string = webApp.properties.defaultHostName
output principalId string = webApp.identity.principalId
```

## Your Mission

Analyze the user's project to:
1. Detect Azure service dependencies from code and configuration
2. Identify required Azure resources (App Service, Storage, Key Vault, Databases, etc.)
3. Extract configuration values from environment files
4. **Propose a complete infrastructure solution** with all Bicep templates
5. **Present the proposed solution** showing all modules, security configurations, and architecture
6. **Get user approval** before generating any files
7. **Generate composable, region-agnostic, secure Bicep modules** following the requirements above
8. Guide the user through infrastructure deployment

## Analysis Process

### Step 1: Scan Project Files for Azure Dependencies

**Important Scanning Guidelines:**
- Use **case-insensitive** searches (both uppercase and lowercase variations)
- Explore **ALL subdirectories recursively** - don't stop at the first level
- **List directory structure first** to understand the full project layout
- Don't exhibit **focus bias** - analyze all components equally (main services, proxies, providers, utilities, etc.)
- Check for **multiple instances** of the same file type in different locations

Look for these indicators:

**.NET Projects** (*.csproj, *.sln):
- **Important**: Find ALL solution files (`**/*.sln`, `**/*.[Ss][Ll][Nn]`) and ALL project files (case-insensitive)
- Search patterns: `**/*.[Cc][Ss][Pp][Rr][Oo][Jj]`, `**/*.[Ff][Ss][Pp][Rr][Oo][Jj]`, `**/*.[Vv][Bb][Pp][Rr][Oo][Jj]`
- Don't limit analysis to a single solution - scan for all solutions and projects recursively
- **Explore all subdirectories**: Some projects may be nested deep in folder structures
- Some projects may not be included in solution files - analyze them independently
- **No focus bias**: Treat all projects equally - main applications, test projects, utilities, proxies, providers, etc.
- Package references to check:
  - `Azure.Storage.Blobs` â†’ Azure Storage Account
  - `Azure.Security.KeyVault.*` â†’ Azure Key Vault
  - `Microsoft.EntityFrameworkCore.SqlServer` â†’ Azure SQL Database
  - `Microsoft.Azure.Cosmos` â†’ Azure Cosmos DB
  - `StackExchange.Redis` â†’ Azure Cache for Redis
  - `Azure.Messaging.ServiceBus` â†’ Azure Service Bus
  - `Azure.Messaging.EventHubs` â†’ Azure Event Hubs
  - `Microsoft.ApplicationInsights` â†’ Application Insights
- Check all `*.csproj` files for `<PackageReference>` elements
- Check `Directory.Build.props` for centralized package management

**Python Projects** (requirements.txt, pyproject.toml):
- `azure-storage-blob` â†’ Azure Storage Account (Blob)
- `azure-keyvault-secrets` â†’ Azure Key Vault
- `azure-identity` â†’ Azure Identity (authentication)
- `psycopg2`, `psycopg2-binary` â†’ Azure Database for PostgreSQL
- `pymongo` â†’ Azure Cosmos DB (MongoDB API)
- `redis` â†’ Azure Cache for Redis
- `azure-servicebus` â†’ Azure Service Bus
- `azure-eventhub` â†’ Azure Event Hubs
- `azure-functions` â†’ Azure Functions
- `flask`, `django`, `fastapi` â†’ Azure App Service (web framework detected)

**Node.js Projects** (package.json):
- `@azure/storage-blob` â†’ Azure Storage Account
- `@azure/keyvault-secrets` â†’ Azure Key Vault
- `@azure/identity` â†’ Azure Identity
- `pg` â†’ Azure Database for PostgreSQL
- `mongodb` â†’ Azure Cosmos DB
- `redis` â†’ Azure Cache for Redis
- `express`, `next`, `react` â†’ Azure App Service or Static Web Apps

**.NET Projects** (.csproj, packages.config):
- `Azure.Storage.Blobs` â†’ Azure Storage Account
- `Azure.Security.KeyVault.Secrets` â†’ Azure Key Vault
- `Azure.Identity` â†’ Azure Identity
- `Npgsql` â†’ Azure Database for PostgreSQL
- `StackExchange.Redis` â†’ Azure Cache for Redis
- ASP.NET Core â†’ Azure App Service

### Step 2: Extract Configuration

Check these files for resource names and configuration:
- `.env` - Environment variables
- `appsettings.json` - .NET configuration
- `config.py` - Python configuration
- `docker-compose.yml` - Container configuration

Look for patterns like:
- `AZURE_STORAGE_ACCOUNT_NAME=mystorageaccount`
- `AZURE_KEY_VAULT_NAME=mykeyvault`
- `DATABASE_HOST=myserver.postgres.database.azure.com`
- `REDIS_HOST=mycache.redis.cache.windows.net`

### Step 3: Analyze and Propose Complete Solution

After detecting dependencies and extracting configuration, **immediately propose a complete infrastructure solution** instead of asking questions.

**DO NOT ask questions** - instead, create an intelligent proposal based on:
- Detected Azure services from code dependencies
- Best practices for each resource type
- **Mandatory security requirements** (private endpoints, NSP, NAT Gateway)
- Sensible defaults for SKUs, scaling, and redundancy
- Standard three-tier environments (dev, staging, production)

**Your proposed solution should include**:
1. **Complete list of all Bicep modules** to be generated
2. **Detailed security architecture** (VNet, subnets, private endpoints, NSP, NAT Gateway)
3. **Network topology** showing how resources connect securely
4. **Parameter strategy** for multi-environment deployment
5. **Resource dependencies and deployment order**
6. **Example module content** showing key configurations

**Present the proposal in this format**:

### Step 4: Present Proposed Infrastructure Solution

After analyzing the project, **immediately present a complete infrastructure proposal** with all security requirements:

```
ğŸ“‹ Detected Azure Resources:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resource Type               â”‚ Suggested Name   â”‚ Confidence â”‚ Evidence                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Azure App Service           â”‚ myapp            â”‚ 95%        â”‚ Flask detected                      â”‚
â”‚ Azure Storage Account       â”‚ mystorageaccount â”‚ 90%        â”‚ azure-storage-blob                  â”‚
â”‚ Azure Key Vault             â”‚ mykeyvault       â”‚ 90%        â”‚ azure-keyvault-*                    â”‚
â”‚ Azure PostgreSQL            â”‚ mydb             â”‚ 85%        â”‚ psycopg2 found                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ Ev2 Configuration Detected:

**If SINGLE ServiceModel found:**
- ServiceModel: ServiceModel.prod.json (5 resources defined)
- RolloutSpec: RolloutSpec.json (3-stage rollout: Validation â†’ Pilot â†’ Production)
- Scope: 3 regions (East US, West US, West Europe)
- Deployment Strategy: Progressive rollout with health checks
- Existing Resources: App Service, Storage, Key Vault, SQL Database, Redis Cache

**If MULTIPLE ServiceModel files found, show separate summary for EACH:**

ğŸ“¦ **Deployment 1: [Project/Component Name]** (from parent folder path)
  Location: ServiceGroupRoot/MainService/
  - ServiceModel: MainService/ServiceModel.json (8 resources)
  - RolloutSpec: MainService/RolloutSpec.json (4-stage rollout: Canary â†’ Region1 â†’ Region2 â†’ Global)
  - Scope: 5 regions (East US, West US, Central US, North Europe, West Europe)
  - Deployment Strategy: Ring-based deployment with automated rollback
  - Resources: App Service (2), Storage (3), Key Vault, SQL Database, Redis Cache

ï¿½ **Deployment 2: [Project/Component Name]** (from parent folder path)
  Location: ServiceGroupRoot/DiagnosticDataProviders/
  - ServiceModel: DiagnosticDataProviders/ServiceModel.json (4 resources)
  - RolloutSpec: DiagnosticDataProviders/RolloutSpec.json (3-stage rollout: Validation â†’ Pilot â†’ Production)
  - Scope: 3 regions (East US, West Europe, Southeast Asia)
  - Deployment Strategy: Progressive rollout with manual approval gates
  - Resources: App Service, Storage, Application Insights, Key Vault

ğŸ“¦ **Deployment 3: [Project/Component Name]** (from parent folder path)
  Location: ServiceGroupRoot/Proxy/
  - ServiceModel: Proxy/ServiceModel.json (3 resources)
  - RolloutSpec: Proxy/RolloutSpec.json (2-stage rollout: Pre-production â†’ Production)
  - Scope: 2 regions (East US, West Europe)
  - Deployment Strategy: Blue-green deployment
  - Resources: App Service, Application Gateway, Key Vault

[Continue for each additional ServiceModel found...]

ï¿½ğŸ”„ Integration Strategy:
- Bicep templates will be generated in: ./bicep-templates/
- Standard Bicep structure compatible with any deployment tool
- Multi-environment parameter files (dev, staging, production)
- Modular templates for each resource type
- Ready for deployment via Azure CLI, Azure DevOps, GitHub Actions, or other CI/CD tools
```

## Using the CLI Tool

After analysis, guide the user to use the Specify CLI:

```bash
# Install Specify CLI with Bicep support
pip install -e ".[bicep]"

# Analyze the current project
specify bicep --analyze-only

# See all options
specify bicep --help
```

The CLI tool will:
- âœ… Automatically scan dependencies
- âœ… Read environment configurations
- âœ… Detect existing Ev2 configuration
- âœ… Display detected resources with confidence scores
- âœ… Provide actionable recommendations

## Bicep Template Generation Strategy

### Output Structure (Standard Bicep)

Generate standard Bicep templates in a clean, modular structure:

```
bicep-templates/
â”œâ”€â”€ README.md                           # ğŸ“‹ COMPLETE GENERATION PLAN (create first!)
â”œâ”€â”€ TODO.md                             # âœ… Progress tracker (create second!)
â”œâ”€â”€ main.bicep                           # Main orchestrator
â”œâ”€â”€ parameters/
â”‚   â”œâ”€â”€ dev.parameters.json             # Dev environment config
â”‚   â”œâ”€â”€ staging.parameters.json         # Staging environment config
â”‚   â””â”€â”€ production.parameters.json      # Production environment config
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ app-service.bicep              # Modular Bicep templates
â”‚   â”œâ”€â”€ storage.bicep
â”‚   â”œâ”€â”€ key-vault.bicep
â”‚   â”œâ”€â”€ database.bicep
â”‚   â”œâ”€â”€ networking.bicep
â”‚   â””â”€â”€ redis.bicep
â””â”€â”€ deploy.sh / deploy.ps1              # Azure CLI deployment scripts
```

## ğŸš« CRITICAL: DO NOT Generate Templates Yet!

**STOP**: Before creating any Bicep templates, you MUST complete these mandatory steps:

### âœ… Pre-Generation Checklist
- [ ] If multiple projects detected: Ask which projects to generate templates for
- [ ] Ask ALL critical architecture questions (see below)
- [ ] Understand scale and redundancy requirements
- [ ] Understand deployment strategy (regions, environments)
- [ ] Create structured generation plan with priorities
- [ ] Get user approval of the plan
- [ ] ONLY THEN proceed with template generation

## ğŸ“¦ Step 0: Project Selection (If Multiple Projects Detected)

**IMPORTANT**: If your analysis discovers multiple projects (multiple deployment configurations in different locations), you MUST ask the user which projects they want to generate Bicep templates for BEFORE asking any other questions.

### When Multiple Projects Detected

Present this question to the user:

```markdown
## ğŸ¯ Project Selection

I've detected **[X] separate projects** in your repository based on deployment configuration locations:

| # | Project Name | Location | Configuration Files | Resources Detected |
|---|--------------|----------|---------------------|-------------------|
| 1 | [Project Name from path] | [Relative path] | [Config files found] | [Count] resources |
| 2 | [Project Name from path] | [Relative path] | [Config files found] | [Count] resources |
| 3 | [Project Name from path] | [Relative path] | [Config files found] | [Count] resources |

**Question**: Which project(s) do you want to generate Bicep templates for?

**Options**:
- **A) All projects** - Generate templates for all [X] projects (will create separate `bicep-templates/` folders for each)
- **B) Select specific projects** - Choose which projects to generate (specify numbers, e.g., "1, 3")
- **C) Single project** - Generate for one project only (specify number)

**Your choice**: [Wait for user response]

---
```

### After User Selection

1. **If "All projects" selected**:
   - Note: "Generating templates for all [X] projects"
   - Continue with questions, but adapt questions to ask about commonalities:
     - "Do all projects share the same deployment regions, or differ per project?" 
     - "Should all projects use the same security patterns (Managed Identity, private endpoints)?"
     - "Do all projects follow the same naming conventions?"
   - For project-specific differences, ask follow-up questions per project

2. **If "Specific projects" selected**:
   - Filter the analysis to only include selected projects
   - Note: "Generating templates for projects: [list selected projects]"
   - Continue with questions focused only on selected projects
   - Ignore resources from unselected projects in subsequent analysis

3. **If "Single project" selected**:
   - Filter to only the selected project
   - Note: "Generating templates for project: [project name]"
   - Continue with questions focused only on this project
   - Treat as single-project scenario

### Adapting Questions for Multiple Projects

**If generating for multiple projects**, adapt the question format:

```markdown
### Q1: Deployment Regions

**What I found**: 
- Project 1 ([name]): Deploys to [regions from config]
- Project 2 ([name]): Deploys to [regions from config]
- Project 3 ([name]): No region configuration detected

**Question**: Deployment regions strategy across your projects:

**Options**:
- **A) All projects use same regions** (specify regions)
- **B) Each project uses different regions** (I'll ask about each project individually)

**Your choice**: [Wait for response]

[If "Each project different" selected, ask separately for each project]
```

Apply this pattern to all relevant questions (scaling, security, naming, etc.) when multiple projects are selected.

### Directory Structure for Multiple Projects

When generating templates for multiple projects, create separate directories:

```
bicep-templates/
â”œâ”€â”€ project-1-[name]/
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ TODO.md
â”‚   â”œâ”€â”€ main.bicep
â”‚   â”œâ”€â”€ modules/
â”‚   â””â”€â”€ parameters/
â”œâ”€â”€ project-2-[name]/
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ TODO.md
â”‚   â”œâ”€â”€ main.bicep
â”‚   â”œâ”€â”€ modules/
â”‚   â””â”€â”€ parameters/
â””â”€â”€ MULTI-PROJECT-README.md  # Overview of all projects
```

## ğŸ’¬ MANDATORY Pre-Generation Questions

**Before creating ANY Bicep templates**, ask the user these critical questions. Wait for responses to ALL questions before proceeding.

**NOTE**: If multiple projects selected in Step 0, adapt questions to account for commonalities and differences across projects.

### ï¿½ Question Set 1: Deployment Regions & Coverage

Present these questions first:

```markdown
## ğŸ¯ Deployment Architecture Questions

I've analyzed your project and need to understand your deployment strategy before generating Bicep templates.

### Q1: Deployment Architecture (Multi-Region Strategy)

**What I found**: [List any region hints from existing configuration or code]

**Question**: What is your deployment architecture strategy?

**ğŸ”’ NOTE**: The Bicep templates will be **100% region-agnostic** (no hardcoded regions). This question helps me understand:
- If you need multi-region deployment scripts/examples
- If you need Traffic Manager or Front Door modules
- If you need geo-replication configuration

**Options**:
- **A) Single region deployment** - Deploy to one region at a time (templates deployable to ANY region)
- **B) Multi-region active-passive** - Primary + DR region with failover (need Traffic Manager)
- **C) Multi-region active-active** - Load balanced across regions (need Front Door/Traffic Manager)
- **D) Global deployment** - Multiple regions per geography (need geo-replication modules)

**Your choice**: [Wait for response]

**Follow-up (informational only)**: Which regions do you typically deploy to? (e.g., "East US, West Europe, Southeast Asia")
- **Note**: This is for documentation/examples only - templates will use `location` parameter and work in ANY region

---

### Q2: Environment Strategy

**Question**: Which environments do you need parameter files for?

**Options**:
- **A) Standard three-tier** - Development, Staging, Production
- **B) Two-tier** - Development, Production (no staging)
- **C) Custom** - Specify your environment names

**Your choice**: [Wait for response]

---
```

### ğŸ“Š Question Set 2: Scale & Redundancy

After receiving answers to Set 1, ask these questions:

```markdown
## ğŸ“ˆ Scale & High Availability Questions

### Q3: Expected User Load & Scaling

**Question**: What are your scale requirements?

**User Load**:
- **Development**: < 100 users
- **Small**: 100-1,000 users
- **Medium**: 1,000-10,000 users  
- **Large**: 10,000-100,000 users
- **Enterprise**: > 100,000 users

**Your expected load**: [Wait for response]

**Scaling Strategy**:
- **A) Manual scaling** - Fixed capacity, scale manually when needed
- **B) Scheduled scaling** - Scale up/down on schedule (business hours)
- **C) Auto-scaling** - Automatic scaling based on metrics (CPU, memory, requests)

**Your preference**: [Wait for response]

---

### Q4: Redundancy & Availability Requirements

**Question**: What are your availability and redundancy requirements?

**Options**:
- **A) Basic** - Single instance, acceptable downtime for maintenance
- **B) Standard** - Multiple instances, zone-redundant storage, minimal downtime
- **C) High Availability** - Availability Zones, geo-redundant storage, <99.9% uptime
- **D) Mission Critical** - Multi-region active-active, <99.99% uptime, instant failover

**Your choice**: [Wait for response]

**Follow-up for HA/Mission Critical**: Should I include:
- âœ… Availability Zones distribution
- âœ… Zone-redundant storage (ZRS) or Geo-redundant storage (GRS)
- âœ… Load balancing (Azure Load Balancer or Application Gateway)
- âœ… Traffic Manager for multi-region routing

**Your selections**: [Wait for response]

---
```

### ğŸ” Question Set 3: Security & Identity

After receiving answers to Set 2, ask these questions:

```markdown
## ğŸ” Security Architecture Questions

### Q5: Managed Identity (MSI) Usage

**What I found**: [If detected in code: "Detected Azure SDK code that could use Managed Identity" | If not: "No explicit MSI usage detected"]

**Question**: Should all Azure resources use Managed Identity for authentication?

**Background**: Managed Identity eliminates the need for:
- Connection strings with credentials
- Service principal secrets
- Access keys in configuration

**Options**:
- **A) System-assigned MSI** - Separate identity per resource (recommended for most cases)
- **B) User-assigned MSI** - Shared identity across resources (better for cross-resource access)
- **C) Mix** - System-assigned for most, user-assigned for specific scenarios
- **D) Traditional** - Keep using connection strings/keys (not recommended)

**Your choice**: [Wait for response]

---

### Q6: Network Security & Private Endpoints

**Question**: What level of network isolation do you need?

**Options**:
- **A) Public endpoints** - Resources accessible from internet (with firewall rules)
- **B) VNet integration** - Resources in Virtual Network with NSGs
- **C) Private endpoints** - Resources accessible only via private IPs in VNet
- **D) Full isolation** - Private endpoints + no public access + Azure Firewall

**Your choice**: [Wait for response]

**If Private Endpoints/Full Isolation**:
- Should I create a new VNet or use existing? [New/Existing - if existing, provide name]
- DNS integration: Private DNS zones for endpoint resolution? [Yes/No]

---

### Q7: Secrets Management

**Question**: How should secrets (connection strings, API keys, passwords) be managed?

**Options**:
- **A) Azure Key Vault** - Centralized secret management (recommended)
- **B) Key Vault + MSI** - Key Vault with Managed Identity access (most secure)
- **C) App Configuration** - Azure App Configuration with Key Vault references
- **D) Environment variables** - Secrets in deployment parameters (not recommended)

**Your choice**: [Wait for response]

---
```

### ğŸ“‹ Question Set 4: Environment & Cost

After receiving answers to Set 3, ask these final questions:

```markdown
## ğŸŒ Environment & Cost Optimization Questions

### Q8: Environment Strategy

**Question**: How many environments do you need, and what are their purposes?

**Common patterns**:
- **A) Simple** - Dev + Production only
- **B) Standard** - Dev + Staging + Production
- **C) Extended** - Dev + QA + Staging + Production
- **D) Custom** - [Let user specify]

**Your choice**: [Wait for response]

**Follow-up**: Should SKUs/sizes differ per environment?
- **Development**: [Basic/Burstable tiers for cost savings]
- **Staging**: [Match production or reduced capacity]
- **Production**: [Full capacity with HA]

---

### Q9: Cost Optimization Priorities

**Question**: What are your cost optimization priorities?

**Select all that apply**:
- [ ] Minimize infrastructure cost (use lower SKUs where possible)
- [ ] Auto-shutdown non-production resources (nights/weekends)
- [ ] Use Azure Hybrid Benefit (if you have licenses)
- [ ] Implement auto-scaling (pay only for what you use)
- [ ] Use Reserved Instances (for predictable workloads)
- [ ] Cost-optimized storage tiers (Cool/Archive for infrequent data)

**Your selections**: [Wait for response]

---
```

### âœ… Question Summary & Confirmation

After receiving ALL answers, present a summary for confirmation:

```markdown
## ğŸ“ Configuration Summary

Based on your answers, here's what I'll generate:

**Deployment Strategy**:
- Architecture: [Active-active/Active-passive/Single region deployment]
- Typical deployment regions: [List regions] *(documentation only - templates are region-agnostic)*
- Environments: [List environments]
- **Note**: All Bicep templates use `location` parameter - deployable to ANY Azure region

**Scale & Availability**:
- Expected load: [Small/Medium/Large/Enterprise]
- Scaling: [Manual/Scheduled/Auto]
- Redundancy: [Basic/Standard/HA/Mission Critical]
- Availability Zones: [Yes/No]
- Load Balancing: [Type if applicable]

**Security**:
- Managed Identity: [System/User/Mix/Traditional]
- Network: [Public/VNet/Private endpoints/Full isolation]
- Secrets: [Key Vault/Key Vault + MSI/App Config/Env vars]

**Environments**:
- Count: [Number and names]
- SKU strategy: [Description]

**Cost Optimization**:
- [List enabled optimizations]

**Template Complexity**: [Simple/Moderate/Complex]

**Estimated templates**: [X] modules + [Y] parameter files + main.bicep

---

**âš ï¸ IMPORTANT**: Please review this summary carefully. Once confirmed, I'll create a detailed generation plan.

**Do you confirm this configuration?** [Yes to proceed / No to revise specific items]

[Wait for confirmation before proceeding]
```

## ğŸ“‹ AFTER Confirmation: Present Detailed Generation Plan

**ONLY AFTER user confirms the configuration summary**, create and present the complete generation plan for user approval.

### ğŸ¯ Step 1: Generate and Present the Plan

Create a comprehensive plan that includes:

```markdown
## ğŸ“‹ Bicep Template Generation Plan

Based on your configuration, here's the complete plan for generating your infrastructure templates:

### ğŸ“ Directory Structure

```
bicep-templates/
â”œâ”€â”€ README.md                           # Complete generation plan documentation
â”œâ”€â”€ TODO.md                             # Progress tracker with validation gates
â”œâ”€â”€ main.bicep                          # Main orchestrator (300-500 lines)
â”œâ”€â”€ parameters/
â”‚   â”œâ”€â”€ dev.parameters.json            # Development environment config
â”‚   â”œâ”€â”€ staging.parameters.json        # Staging environment config
â”‚   â””â”€â”€ production.parameters.json     # Production environment config
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ networking.bicep               # VNet, subnets, NSGs (200-300 lines)
â”‚   â”œâ”€â”€ key-vault.bicep                # Key Vault with RBAC (150-200 lines)
â”‚   â”œâ”€â”€ storage.bicep                  # Storage accounts (150-200 lines)
â”‚   â”œâ”€â”€ app-service-plan.bicep         # App Service Plan (100-150 lines)
â”‚   â”œâ”€â”€ app-service.bicep              # Web App with MSI (200-300 lines)
â”‚   â”œâ”€â”€ [additional modules...]        # [Estimated lines]
â”œâ”€â”€ ev2-integration/                    # (If Ev2 detected)
â”‚   â”œâ”€â”€ README.md                       # Integration guide
â”‚   â”œâ”€â”€ servicemodel-template.json      # ServiceModel update template
â”‚   â””â”€â”€ rolloutspec-template.json       # RolloutSpec reference
â””â”€â”€ deployment/
    â”œâ”€â”€ deploy.sh                       # Bash deployment script
    â””â”€â”€ deploy.ps1                      # PowerShell deployment script
```

**Total estimated files**: [X] Bicep modules + [Y] parameter files + [Z] supporting files = **[Total] files**

---

### ğŸ¯ Generation Sequence (Priority Order)

#### Phase 1: Foundation Modules (HIGH PRIORITY)
**These must be created first as other resources depend on them**

1. **networking.bicep** âš¡ CRITICAL PATH
   - Virtual Network with [X] subnets
   - Network Security Groups
   - [Private endpoints configuration if applicable]
   - **Dependencies**: None
   - **Estimated complexity**: [Low/Medium/High]
   - **Why first**: All other resources need VNet for private connectivity

2. **key-vault.bicep** âš¡ CRITICAL PATH
   - Key Vault with [RBAC/Access Policies]
   - Soft delete and purge protection enabled
   - [MSI access configuration]
   - **Dependencies**: None (or networking if private endpoint)
   - **Estimated complexity**: [Low/Medium/High]
   - **Why second**: Other resources need Key Vault for secrets

#### Phase 2: Core Services (MEDIUM PRIORITY)
**Can be created in parallel after Phase 1 completes**

3. **storage.bicep**
   - Storage Account: [name pattern]
   - Services: [blob/file/queue/table]
   - Security: TLS 1.2+, [public/private access]
   - **Dependencies**: [networking if private endpoints]
   - **Estimated complexity**: [Low/Medium/High]

4. **app-service-plan.bicep**
   - SKU: [Dev: Basic, Staging: Standard, Prod: Premium]
   - [Zone redundancy if HA required]
   - [Auto-scale configuration if enabled]
   - **Dependencies**: [networking if VNet integration]
   - **Estimated complexity**: [Low/Medium/High]

[List all Phase 2 modules...]

#### Phase 3: Applications (LOW PRIORITY)
**Depend on Phase 1 & 2 completion**

5. **app-service.bicep**
   - Web App with [runtime]
   - Managed Identity: [System-assigned/User-assigned]
   - Key Vault integration for secrets
   - VNet integration: [Yes/No]
   - **Dependencies**: app-service-plan, key-vault, storage, [networking]
   - **Estimated complexity**: [Low/Medium/High]

[List all Phase 3 modules...]

#### Phase 4: Orchestration & Configuration

6. **main.bicep**
   - Orchestrates all modules
   - Parameter passing and output collection
   - Dependency management
   - **Dependencies**: ALL modules above
   - **Estimated complexity**: Medium

7. **Parameter files** (3 files)
   - dev.parameters.json: [SKU levels, resource names]
   - staging.parameters.json: [SKU levels, resource names]
   - production.parameters.json: [SKU levels, HA config, resource names]

8. **Deployment scripts** (2 files)
   - deploy.sh: Bash deployment with validation
   - deploy.ps1: PowerShell deployment with validation

---

### ğŸ”— Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: Foundation (Create First)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. networking.bicep â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ 2. key-vault.bicep â”€â”€â”€â”€â”€â”€â”€â”   â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: Core Services (Parallel after Phase 1)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. storage.bicep [needs: networking?]                â”‚
â”‚ 4. app-service-plan.bicep [needs: networking?]       â”‚
â”‚ 5. [other core services...]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: Applications (After Phase 1 & 2)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. app-service.bicep [needs: plan, kv, storage, net]â”‚
â”‚ 7. [other applications...]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4: Integration (Final)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8. main.bicep [orchestrates all]                    â”‚
â”‚ 9. parameters/*.json [3 files]                      â”‚
â”‚ 10. deployment scripts [2 files]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ” Security Implementation Plan

Based on your requirements, I will implement:

- âœ… **Managed Identity**: [System-assigned/User-assigned] for all resources
- âœ… **Key Vault**: Centralized secret management with [RBAC/Access Policies]
- âœ… **Network Security**: [Public endpoints with firewall / VNet integration / Private endpoints / Full isolation]
- âœ… **TLS/HTTPS**: Enforce TLS 1.2+ and HTTPS-only for all web resources
- âœ… **No Hardcoded Secrets**: All secrets via Key Vault references
- âœ… **RBAC**: Least privilege access for all identities

---

### ğŸŒ Multi-Environment Strategy

**Environments**: [dev, staging, production]

**Differentiation strategy**:
- **SKUs**: Dev uses [Basic/Standard], Staging uses [Standard], Production uses [Premium/HA tiers]
- **Scaling**: Dev [manual], Staging [manual/scheduled], Production [auto-scale]
- **Redundancy**: Dev [single instance], Staging [multiple instances], Production [HA with availability zones]
- **Regions**: Dev [single region], Staging [single region], Production [multi-region if applicable]

---

### ğŸ“Š Estimated Effort

| Phase | Templates | Complexity | Est. Time | Validation Time |
|-------|-----------|------------|-----------|-----------------|
| Phase 1 | 2 modules | Medium | 30-45 min | 10-15 min |
| Phase 2 | [X] modules | Low-Medium | [X] min | [Y] min |
| Phase 3 | [X] modules | Medium-High | [X] min | [Y] min |
| Phase 4 | [X] files | Medium | [X] min | [Y] min |
| **Total** | **[X] files** | **Mixed** | **[Total] min** | **[Total] min** |

**Total estimated time**: [X] hours (including validation gates)

---

### ğŸš¦ Validation Gates

After generating each module, I will:

1. âœ… **Syntax validation**: `az bicep build --file [module].bicep`
2. âœ… **Hardcoded values check**: NO hardcoded regions, environments, SKUs, names, IPs, or secrets
3. âœ… **Region-agnostic check**: All location values use `location` parameter
4. âœ… **Parameterization check**: All configurable values are parameters with defaults where appropriate
5. âœ… **Output completeness**: Module exports IDs, endpoints, identities for cross-component wiring
6. âœ… **Security review**: Key Vault references, Managed Identity, TLS enforcement, RBAC
7. âœ… **Composability check**: Module can be deployed standalone or orchestrated
8. âœ… **Best practices**: Naming conventions, parameter descriptions, idempotency
9. âœ… **Simplicity check**: Ensure code is as simple as possible, no Ev2 concepts
10. âœ… **Critique**: Document what works well and areas for improvement
11. â›” **BLOCK if errors**: Will NOT proceed until validation passes

---

### ï¿½ Naming Conventions

Based on your project, I will use:

**Pattern**: `{service}-{environment}-{region}`

**Examples**:
- App Service: `[app-name]-prod-eastus`
- Storage Account: `[appname]prodstorage` (no hyphens, lowercase only)
- Key Vault: `[app-name]-prod-kv`
- Resource Group: `[app-name]-prod-rg`

**Environment suffixes**: `dev`, `staging`, `prod`

---

### ğŸ”§ Special Considerations

[Based on user responses, list any special considerations:]

- Templates are deployment-agnostic (work with Azure CLI, Azure DevOps, GitHub Actions, or any deployment tool)
- [If multi-region]: Templates will support multi-region deployment with [active-active/active-passive]
- [If availability zones]: Resources will be zone-redundant where applicable
- [If private endpoints]: VNet and private DNS zones will be configured
- [If specific SKU requirements]: Will use [specific SKUs] as specified
- [Any other special requirements from Q&A]

---

## âš ï¸ CRITICAL: WAIT FOR USER APPROVAL

**Before I start generating any Bicep templates, please review this plan carefully.**

### Review Checklist:

- [ ] Directory structure looks correct
- [ ] Generation sequence (priority order) makes sense
- [ ] Dependencies are correctly identified
- [ ] Security implementation matches your requirements
- [ ] Multi-environment strategy is appropriate
- [ ] Naming conventions are acceptable
- [ ] Special considerations cover your needs
- [ ] Estimated effort seems reasonable

### Your Options:

**Option A: Approve and Proceed** âœ…
- Type: "**Approved**" or "**Yes, proceed**" or "**Looks good**"
- I will immediately start generating templates following this exact plan

**Option B: Request Changes** ğŸ”§
- Specify what needs to change (e.g., "Use different naming convention", "Add database module", "Change dependency order")
- I will revise the plan and present it again for approval

**Option C: Ask Questions** â“
- Ask about any part of the plan that's unclear
- I will clarify and then ask for approval again

**Option D: Cancel** âŒ
- Type: "**Cancel**" or "**Stop**"
- I will stop without generating any files

---

**Your response**: [Wait for user input - DO NOT PROCEED until user explicitly approves]

```

### ğŸš¨ CRITICAL RULE: DO NOT GENERATE TEMPLATES WITHOUT APPROVAL

**STOP**: After presenting the plan above:

1. âœ… **WAIT** for explicit user approval
2. âœ… **DO NOT** create any Bicep files until approved
3. âœ… **DO NOT** create README.md or TODO.md until approved
4. âœ… **ONLY** proceed after user types approval (e.g., "Approved", "Yes", "Proceed", "Looks good")
5. âš ï¸ **IF** user requests changes: Revise plan and present again for approval
6. âš ï¸ **IF** user asks questions: Answer, then ask for approval again
7. âŒ **IF** user cancels: Stop immediately without creating any files

**Approval keywords**: "approved", "yes", "proceed", "looks good", "start", "go ahead", "ok", "correct"
**Revision keywords**: "change", "modify", "different", "instead", "update", "revise"
**Question keywords**: "why", "how", "what", "explain", "clarify"
**Cancel keywords**: "cancel", "stop", "no", "abort", "don't"

---

## ğŸ“‹ AFTER User Approves: Begin Template Generation

**ONLY AFTER user explicitly approves the plan**, proceed with this sequence:

### Step 1: Create README.md (Generation Plan Documentation)

Create `bicep-templates/README.md` that documents the approved plan:

```markdown
# Bicep Infrastructure Generation Plan

Generated: [Date and Time]
Project: [Project Name]
**Status**: âœ… APPROVED BY USER - Ready for generation

## ğŸ“Š Overview

**Detected Resources**: [X] Azure resources identified
**Target Environments**: dev, staging, production
**Typical Deployment Regions**: [List regions] *(templates are region-agnostic - deployable to ANY region via `location` parameter)*
**Estimated Completion**: [X] files to generate
**Generation Started**: [Date and Time]

## ğŸ¯ Generation Goals

1. Generate modular Bicep templates for all detected resources
2. Create multi-environment parameter files
3. Provide deployment scripts for Azure CLI
4. Ensure security best practices (HTTPS, TLS 1.2+, RBAC)
5. Implement proper dependency management

## ğŸ—ï¸ Directory Structure

```
bicep-templates/
â”œâ”€â”€ README.md (this file)
â”œâ”€â”€ TODO.md (progress tracker)
â”œâ”€â”€ main.bicep
â”œâ”€â”€ parameters/
â”‚   â”œâ”€â”€ dev.parameters.json
â”‚   â”œâ”€â”€ staging.parameters.json
â”‚   â””â”€â”€ production.parameters.json
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ [list all module files to be created]
â””â”€â”€ deployment scripts (deploy.sh, deploy.ps1)
```

## ğŸ¨ Design Principles

### Core Philosophy: Simplicity First

**Golden Rule**: Keep templates as simple as complexity allows.

1. **Modularity**: Each Azure resource type in separate, composable module
2. **Region-Agnostic**: NO hardcoded regions - always use `location` parameter (defaults to `resourceGroup().location`)
3. **Environment-Agnostic**: NO environment-specific values baked into Bicep - use parameters for all configs
4. **Composable Units**: Modules can be deployed independently or as staged units by orchestration tools
5. **Comprehensive Parameterization**: All configurable values as parameters (location, namePrefix, sku, tags, etc.)
6. **Rich Outputs**: Export resource IDs, endpoints, and identities for cross-component wiring
7. **Security**: No hardcoded secrets, use Key Vault references and Managed Identity
8. **Deployment Agnostic**: Templates work with any deployment tool (Azure CLI, DevOps, GitHub Actions, Ev2, etc.)
9. **Idempotency**: Templates can be re-run safely
10. **Documentation**: Inline comments explaining design decisions
11. **Simplicity**: Prefer built-in solutions over custom implementations

### ğŸš« CRITICAL RULES: What NEVER to Hardcode

**NEVER hardcode these in Bicep templates** - always use parameters:

âŒ **FORBIDDEN**:
- **Regions/Locations**: Never `'eastus'`, `'westeurope'`, etc. â†’ Always use `location` parameter
- **Environment names**: Never `'prod'`, `'dev'`, `'staging'` â†’ Use parameters
- **Resource names**: Never `'myapp-storage'` â†’ Use `namePrefix` parameter + naming convention
- **SKUs**: Never `'Standard_LRS'`, `'B1'` â†’ Use `sku` parameter with defaults
- **Secrets/Passwords**: Never connection strings, keys â†’ Use Key Vault references
- **Subscription IDs**: Never specific subscription â†’ Use deployment scope
- **Tenant IDs**: Never specific tenant â†’ Use `tenant()` function if needed
- **IP Addresses**: Never specific IPs â†’ Use parameters
- **Regions in tags**: Never `tags: { region: 'eastus' }` â†’ Use `location` variable in tags

âœ… **REQUIRED PATTERN**:
```bicep
// âœ… CORRECT: Region-agnostic, parameterized
param location string = resourceGroup().location
param namePrefix string
param environment string
param sku string = 'Standard_LRS'

var resourceName = '${namePrefix}-${environment}'

resource storage 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: resourceName
  location: location  // âœ… Parameter, not hardcoded
  sku: {
    name: sku  // âœ… Parameter with sensible default
  }
  tags: {
    environment: environment
    deployedTo: location  // âœ… Variable, not hardcoded
  }
}
```

### Simplicity Guidelines

âœ… **PREFER** (Always choose the simpler option):
- Built-in Bicep modules when available
- Single-purpose, composable modules (one resource type per file)
- Clear, descriptive parameter names (e.g., `storageAccountName` not `stgActNm`)
- Standard Azure SKUs as parameter defaults
- Inline documentation for non-obvious design decisions
- Flat module hierarchy (avoid deep nesting)

âš ï¸ **AVOID** (Unless complexity is required):
- âŒ **Hardcoded values**: Regions, environments, specific names, SKUs, IPs, secrets
- âŒ **Ev2-specific concepts**: No ServiceModel references, RolloutSpec logic, or Ev2 terminology in Bicep
- âŒ **Environment-specific logic**: No `if environment == 'prod'` conditionals - use parameters instead
- Complex conditional logic (nested if/then/else) - prefer parameter-driven configuration
- Custom resource types when standard ones exist
- Deeply nested modules (> 2 levels) - keep composable and flat
- Terse abbreviations that obscure meaning
- Premature optimization (YAGNI - You Aren't Gonna Need It)
- Over-engineering for hypothetical future needs

ğŸ“ **DOCUMENT** (When complexity is unavoidable):
- **Why** this complex approach was chosen
- **What** simpler alternatives were considered
- **Trade-offs**: Benefits vs. increased complexity
- **Future**: Opportunities to simplify later

### Simplicity Checklist (Apply to Each Template)

Before finalizing any template, ask:
- [ ] **NO hardcoded regions/locations?** All location values use `location` parameter?
- [ ] **NO hardcoded environments?** All environment-specific values are parameters?
- [ ] **NO hardcoded resource names?** Names constructed from parameters (`namePrefix`, `environment`)?
- [ ] **NO hardcoded SKUs?** All SKUs are parameters with sensible defaults?
- [ ] **NO Ev2 concepts?** Template is pure Bicep with no deployment orchestration logic?
- [ ] **Composable module?** Can this be deployed standalone or as part of larger deployment?
- [ ] **Rich outputs?** Exports resource IDs, endpoints, identities for wiring to other components?
- [ ] Could this be simpler without losing required functionality?
- [ ] Are there built-in modules we could use instead of custom code?
- [ ] Are parameter names self-documenting?
- [ ] Is the resource dependency chain clear and minimal?
- [ ] Can a developer unfamiliar with this project understand it in 5 minutes?
- [ ] Have we avoided premature optimization?
- [ ] Is every line of complexity justified and documented?

### Example: Hardcoded vs. Region-Agnostic Composable Module

âŒ **WRONG - Hardcoded & Environment-Specific**:
```bicep
// âŒ Hardcoded region
resource storage 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: 'myappstorage'
  location: 'eastus'  // âŒ WRONG: Hardcoded region
  sku: {
    name: 'Standard_LRS'  // âŒ WRONG: Hardcoded SKU
  }
}

// âŒ Environment-specific conditional logic
var sku = environment == 'prod' ? 'Premium_LRS' : 'Standard_LRS'  // âŒ WRONG: Baked-in logic
```

âœ… **CORRECT - Region-Agnostic, Composable, Parameterized**:
```bicep
@description('Azure region for deployment')
param location string = resourceGroup().location  // âœ… Parameter with sensible default

@description('Name prefix for resource naming')
param namePrefix string  // âœ… Required parameter

@description('Environment identifier (provided by deployment config)')
param environment string  // âœ… Passed from external config/bindings

@description('Storage account SKU')
param storageAccountSku string = 'Standard_LRS'  // âœ… Parameter with default

@description('Enable hierarchical namespace for data lake')
param enableHierarchicalNamespace bool = false  // âœ… Feature flag as parameter

// Construct name from parameters (no hardcoding)
var storageAccountName = toLower('${namePrefix}${environment}sa')

resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: storageAccountName
  location: location  // âœ… From parameter
  sku: {
    name: storageAccountSku  // âœ… From parameter
  }
  kind: 'StorageV2'
  properties: {
    isHnsEnabled: enableHierarchicalNamespace
    supportsHttpsTrafficOnly: true
    minimumTlsVersion: 'TLS1_2'
  }
  tags: {
    environment: environment
    deployedTo: location  // âœ… Variable, not hardcoded
  }
}

// âœ… Rich outputs for cross-component wiring
output storageAccountId string = storageAccount.id
output storageAccountName string = storageAccount.name
output primaryEndpoints object = storageAccount.properties.primaryEndpoints
output storageAccountLocation string = storageAccount.location
```

**Key Differences**:
- âœ… NO hardcoded `location` - uses parameter (deployable to any region)
- âœ… NO hardcoded SKU - uses parameter (configurable per deployment)
- âœ… NO hardcoded names - constructed from parameters
- âœ… NO environment logic baked in - environment comes from parameter/config
- âœ… Composable - can be deployed standalone or with other modules
- âœ… Rich outputs - resource ID and endpoints for wiring to other components

### ğŸ“ Standard Module Template Pattern

**Every module MUST follow this pattern for composability and region-agnosticism**:

```bicep
// ============================================================================
// PARAMETERS (NO defaults for required values - come from deployment config)
// ============================================================================

@description('Azure region for all resources')
param location string = resourceGroup().location  // Default to RG location

@description('Name prefix for resource naming convention')
param namePrefix string  // REQUIRED - no default

@description('Environment identifier')
param environment string  // REQUIRED - comes from bindings/config

@description('Resource-specific configuration')
param sku string = 'Standard'  // Optional with sensible default

@description('Resource tags')
param tags object = {}  // Optional

// ============================================================================
// VARIABLES (Computed from parameters - no hardcoding)
// ============================================================================

var resourceName = '${namePrefix}-${environment}-resource'
var mergedTags = union(tags, {
  environment: environment
  deployedTo: location
  managedBy: 'bicep'
})

// ============================================================================
// RESOURCES (Use parameters for ALL configurable values)
// ============================================================================

resource example 'Microsoft.Provider/resourceType@2023-01-01' = {
  name: resourceName
  location: location  // âœ… From parameter
  sku: {
    name: sku  // âœ… From parameter
  }
  properties: {
    // All properties from parameters
  }
  tags: mergedTags
}

// ============================================================================
// OUTPUTS (Export everything needed for cross-component wiring)
// ============================================================================

@description('Resource ID for ARM references')
output resourceId string = example.id

@description('Resource name for configurations')
output resourceName string = example.name

@description('Resource location')
output resourceLocation string = example.location

@description('Managed identity principal ID (if applicable)')
output principalId string = example.identity.principalId

@description('Resource-specific endpoints/properties')
output endpoint string = example.properties.endpoint
```

**This pattern ensures**:
- âœ… **Region-agnostic**: Deployable to any Azure region
- âœ… **Environment-agnostic**: No environment-specific logic
- âœ… **Composable**: Can be deployed independently or orchestrated
- âœ… **Wirable**: Rich outputs for connecting to other components
- âœ… **Configurable**: All values from parameters, not hardcoded
- âœ… **No Ev2 concepts**: Pure Bicep, orchestration-agnostic

## ğŸ“ Resource Modules to Generate

### 1. [Resource Name] (e.g., App Service)
- **File**: `modules/app-service.bicep`
- **Dependencies**: App Service Plan
- **Parameters**: name, location, sku, runtime
- **Security**: Managed Identity, HTTPS only
- **Notes**: [Any specific configuration based on analysis]

### 2. [Resource Name] (e.g., Storage Account)
- **File**: `modules/storage.bicep`
- **Dependencies**: None
- **Parameters**: name, location, sku, containers
- **Security**: TLS 1.2+, disable public access if needed
- **Notes**: [Any specific configuration]

[Continue for each resource...]

## ğŸ¯ Structured Task Plan with Priorities

**CRITICAL**: Generate templates in dependency order with proper prioritization.

### Priority Matrix

| Priority | Module | File | Dependencies | Complexity | Rationale |
|----------|--------|------|--------------|------------|-----------|
| ğŸ”´ HIGH | Networking | `modules/networking.bicep` | None | Medium | Foundation - all other resources need VNet |
| ğŸ”´ HIGH | Key Vault | `modules/key-vault.bicep` | None | Low | Required for secrets by other resources |
| ğŸŸ¡ MEDIUM | Storage | `modules/storage.bicep` | [VNet if private] | Low | Independent storage resources |
| ğŸŸ¡ MEDIUM | App Service Plan | `modules/app-service-plan.bicep` | [VNet if integration] | Low | Required by App Service |
| ğŸŸ¢ LOW | App Service | `modules/app-service.bicep` | Plan, KV, Storage | Medium | Depends on multiple resources |
| ğŸŸ¢ LOW | [Other resources] | [...] | [...] | [...] | [...] |

### Task Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: Foundation (NO dependencies)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. networking.bicep â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚ 2. key-vault.bicep â”€â”€â”€â”€â”€â”€â”   â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: Core Services (Depend on Phase 1)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. storage.bicep [needs networking if private]                â”‚
â”‚ 4. app-service-plan.bicep [needs networking if vnet-integrated]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: Applications (Depend on Phase 1 & 2)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. app-service.bicep [needs plan, key-vault, storage]         â”‚
â”‚ 6. function-app.bicep [needs plan, key-vault, storage]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4: Integration & Orchestration                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. main.bicep [orchestrates all modules]                      â”‚
â”‚ 8. parameters/*.json [environment-specific configs]           â”‚
â”‚ 9. deployment scripts [automation]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Critical Path

**Shortest path to working deployment**:
1. networking.bicep â†’ 2. key-vault.bicep â†’ 3. storage.bicep â†’ 4. app-service-plan.bicep â†’ 5. app-service.bicep â†’ 6. main.bicep

**Estimated time**: [Calculate based on complexity]

### Task Complexity Assessment

- **Low Complexity** (15-30 min): Single-purpose resources with few parameters
  - Key Vault, Storage Account, App Service Plan
  
- **Medium Complexity** (30-60 min): Resources with multiple configurations
  - Virtual Network (subnets, NSGs), App Service (settings, identity)
  
- **High Complexity** (60+ min): Resources with complex dependencies or configurations
  - Multi-region setups, Load Balancers with complex rules, Database clusters

## ğŸ”— Resource Dependencies (Detailed)

```
main.bicep
â”œâ”€[DEPENDS_ON]â”€â–º networking.bicep (FIRST - provides VNet for all)
â”œâ”€[DEPENDS_ON]â”€â–º key-vault.bicep (SECOND - provides secrets for all)
â”œâ”€[DEPENDS_ON]â”€â–º storage.bicep
â”‚  â””â”€[DEPENDS_ON]â”€â–º networking.bicep (if private endpoints)
â”œâ”€[DEPENDS_ON]â”€â–º app-service-plan.bicep
â”‚  â””â”€[DEPENDS_ON]â”€â–º networking.bicep (if VNet integration)
â”œâ”€[DEPENDS_ON]â”€â–º app-service.bicep
â”‚  â”œâ”€[DEPENDS_ON]â”€â–º app-service-plan.bicep
â”‚  â”œâ”€[DEPENDS_ON]â”€â–º key-vault.bicep (for secrets)
â”‚  â”œâ”€[DEPENDS_ON]â”€â–º storage.bicep (for connection)
â”‚  â””â”€[DEPENDS_ON]â”€â–º networking.bicep (for VNet integration)
â””â”€[DEPENDS_ON]â”€â–º [additional resources...]
```

**Dependency Rules**:
1. **Never create circular dependencies** (Aâ†’Bâ†’A)
2. **Foundation first**: networking, key-vault before all others
3. **Service tier before apps**: plans/accounts before services that use them
4. **Test each module independently** before integration

## ğŸŒ Environment Configuration

### Development
- SKUs: Basic/Standard tiers
- Typical Deployment: Single region *(templates work in any region via `location` parameter)*
- Scale: Minimal

### Staging
- SKUs: Standard tier
- Typical Deployment: Single or dual region *(region selected at deployment time)*
- Scale: Medium

### Production
- SKUs: Premium tier
- Typical Deployment: Multi-region if needed *(each deployment specifies target region)*
- Scale: Auto-scale enabled

**Note**: All templates are **region-agnostic** - the `location` parameter determines deployment region at runtime. No regions are hardcoded.

## ğŸ” Security Considerations

- All secrets in Azure Key Vault
- Managed Identity for authentication
- Private endpoints where applicable
- Network Security Groups for isolation
- RBAC with least privilege
- TLS 1.2+ enforced

## âœ… Generation Tasks (see TODO.md for progress)

Total: [X] tasks
- [ ] Create directory structure
- [ ] Generate main.bicep
- [ ] Generate module: [resource 1]
- [ ] Generate module: [resource 2]
- [ ] Create parameter files (3 environments)
- [ ] Create deployment scripts
- [ ] Validate all templates
- [ ] Generate deployment documentation

## ğŸš€ Deployment Instructions

[To be completed after generation]

## ğŸ“š References

- Azure Bicep Documentation: https://docs.microsoft.com/azure/azure-resource-manager/bicep/
- Azure CLI Documentation: https://docs.microsoft.com/cli/azure/
- Generated infrastructure analysis: ../infrastructure-analysis-report.md
```

Use the `create_file` tool to create this README.md file.

### âœ… Step 2: Create Progress Tracker with Validation Gates (TODO.md)

**AFTER creating README.md**, create `bicep-templates/TODO.md` to track generation progress **with validation gates**:

```markdown
# Bicep Template Generation - Progress Tracker

Generated: [Date and Time]
Last Updated: [Date and Time]

## ğŸ“Š Progress Overview

**Overall**: 0/[X] tasks complete (0%)
**Validation Status**: âœ… All green | âš ï¸ [N] warnings | âŒ [N] errors

## ğŸ“‹ Task List with Validation Gates

### Phase 1: Setup and Planning
- [x] Create README.md with generation plan
- [x] Create TODO.md for progress tracking
- [ ] Create directory structure

### Phase 2: Core Infrastructure
- [ ] Generate `main.bicep` (main orchestrator)
  - [ ] Create initial template
  - [ ] **ğŸš¦ VALIDATION GATE #1**:
    - [ ] Syntax: Run `az bicep build --file main.bicep`
    - [ ] Linting: Check for warnings
    - [ ] Hardcoded values: NO regions, environments, names, SKUs hardcoded
    - [ ] Region-agnostic: All `location` values use parameters
    - [ ] Parameters: Verify all parameters have descriptions and sensible defaults
    - [ ] Outputs: Verify necessary outputs defined (resource IDs, endpoints)
    - [ ] Composability: Can be deployed standalone or orchestrated
    - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS
  - [ ] Fix any errors (if blocked)
  - [ ] Document validation results
  - [ ] **GATE RESULT**: [PASS required to proceed]

### Phase 3: Foundation Modules (HIGH PRIORITY - Required by Others)

#### 3.1 Networking Module
- [ ] Generate `modules/networking.bicep`
  - [ ] Create VNet with subnets
  - [ ] Add NSGs and security rules
  - [ ] Configure private endpoints if needed
  - [ ] **ğŸš¦ VALIDATION GATE #2**:
    - [ ] Syntax: `az bicep build --file modules/networking.bicep`
    - [ ] Security: Verify NSG rules are restrictive
    - [ ] Best Practices: Check subnet sizing, address spaces
    - [ ] Naming: Verify naming conventions
    - [ ] Simplicity: âœ… Simple | âš ï¸ Complex (if complex, justify below)
    - [ ] **Critique**:
      ```
      [Write review comments here]
      - What works well?
      - What could be improved?
      - Any security concerns?
      - Complexity justified?
      ```
    - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS
  - [ ] Fix any errors (if blocked)
  - [ ] **GATE RESULT**: [PASS required to proceed]

#### 3.2 Key Vault Module
- [ ] Generate `modules/key-vault.bicep`
  - [ ] Create Key Vault
  - [ ] Configure RBAC access policies
  - [ ] Enable soft delete and purge protection
  - [ ] **ğŸš¦ VALIDATION GATE #3**:
    - [ ] Syntax: `az bicep build --file modules/key-vault.bicep`
    - [ ] Security: Verify purge protection enabled
    - [ ] Security: Verify RBAC (not legacy access policies)
    - [ ] Security: Verify TLS 1.2+ required
    - [ ] Managed Identity: Verify MSI access configured
    - [ ] Simplicity: âœ… Simple | âš ï¸ Complex (if complex, justify below)
    - [ ] **Critique**:
      ```
      [Write review comments here]
      ```
    - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS
  - [ ] Fix any errors (if blocked)
  - [ ] **GATE RESULT**: [PASS required to proceed]

### Phase 4: Core Services Modules (MEDIUM PRIORITY)

#### 4.1 Storage Account Module
- [ ] Generate `modules/storage.bicep`
  - [ ] Create Storage Account
  - [ ] Configure blob/file/queue/table services
  - [ ] Enable TLS 1.2+, disable public access if needed
  - [ ] **ğŸš¦ VALIDATION GATE #4**:
    - [ ] Syntax: `az bicep build --file modules/storage.bicep`
    - [ ] Security: TLS 1.2+ enforced
    - [ ] Security: Public access appropriately configured
    - [ ] Dependencies: Depends on networking if private endpoints
    - [ ] Simplicity: âœ… Simple | âš ï¸ Complex
    - [ ] **Critique**:
      ```
      [Write review comments here]
      ```
    - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS
  - [ ] Fix any errors (if blocked)
  - [ ] **GATE RESULT**: [PASS required to proceed]

#### 4.2 App Service Plan Module
- [ ] Generate `modules/app-service-plan.bicep`
  - [ ] Create App Service Plan with appropriate SKU
  - [ ] Configure zone redundancy if required
  - [ ] **ğŸš¦ VALIDATION GATE #5**:
    - [ ] Syntax: `az bicep build --file modules/app-service-plan.bicep`
    - [ ] SKU: Verify matches requirements (dev/staging/prod)
    - [ ] Scaling: Auto-scale configured if required
    - [ ] Zones: Availability zones if HA required
    - [ ] Simplicity: âœ… Simple | âš ï¸ Complex
    - [ ] **Critique**:
      ```
      [Write review comments here]
      ```
    - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS
  - [ ] Fix any errors (if blocked)
  - [ ] **GATE RESULT**: [PASS required to proceed]

### Phase 5: Application Modules (LOW PRIORITY - Depend on Above)

#### 5.1 App Service Module
- [ ] Generate `modules/app-service.bicep`
  - [ ] Create App Service
  - [ ] Configure Managed Identity (system or user-assigned)
  - [ ] Add Key Vault references for secrets
  - [ ] Configure VNet integration if needed
  - [ ] **ğŸš¦ VALIDATION GATE #6**:
    - [ ] Syntax: `az bicep build --file modules/app-service.bicep`
    - [ ] Dependencies: Correctly depends on plan, Key Vault, storage
    - [ ] Managed Identity: System-assigned or user-assigned configured
    - [ ] Secrets: Using Key Vault references (no hardcoded secrets)
    - [ ] HTTPS: HTTPS-only enforced
    - [ ] Simplicity: âœ… Simple | âš ï¸ Complex
    - [ ] **Critique**:
      ```
      [Write review comments here]
      ```
    - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS
  - [ ] Fix any errors (if blocked)
  - [ ] **GATE RESULT**: [PASS required to proceed]

[Continue for each additional module with similar validation gate structure...]

### Phase 6: Environment Parameters
- [ ] Generate `parameters/dev.parameters.json`
  - [ ] **ğŸš¦ VALIDATION GATE**: Valid JSON, matches main.bicep parameters
  - [ ] **STATUS**: âŒ BLOCKED | âœ… PASS
  
- [ ] Generate `parameters/staging.parameters.json`
  - [ ] **ğŸš¦ VALIDATION GATE**: Valid JSON, matches main.bicep parameters
  - [ ] **STATUS**: âŒ BLOCKED | âœ… PASS
  
- [ ] Generate `parameters/production.parameters.json`
  - [ ] **ğŸš¦ VALIDATION GATE**: Valid JSON, matches main.bicep parameters
  - [ ] **STATUS**: âŒ BLOCKED | âœ… PASS

### Phase 7: Deployment Automation
- [ ] Generate `deploy.sh` (Bash deployment script)
- [ ] Generate `deploy.ps1` (PowerShell deployment script)
- [ ] Add validation commands

### Phase 8: Final Validation
- [ ] **ğŸš¦ FINAL VALIDATION GATE**:
  - [ ] All module syntax validated
  - [ ] All parameter files validated
  - [ ] Dependency order correct
  - [ ] No circular dependencies
  - [ ] Security best practices applied
  - [ ] Simplicity guidelines followed
  - [ ] **COMPREHENSIVE TEST**:
    ```bash
    # Build all templates
    az bicep build --file main.bicep
    
    # Validate deployment (what-if)
    az deployment group what-if \
      --resource-group <test-rg> \
      --template-file main.bicep \
      --parameters @parameters/dev.parameters.json
    ```
  - [ ] **STATUS**: âŒ BLOCKED | âš ï¸ WARNINGS | âœ… PASS

### Phase 9: Documentation
- [ ] Update README.md with deployment instructions
- [ ] Add inline comments to all Bicep files
- [ ] Document any deviations from plan
- [ ] Create deployment runbook

## ğŸš¦ Validation Gate Rules

**CRITICAL RULES**:
1. **NO progression** to next template until current gate shows âœ… PASS
2. **BLOCKED status** requires immediate fix before continuing
3. **WARNING status** can proceed with documented justification
4. **All critiques** must be written - document what works and what doesn't
5. **Simplicity violations** must be justified in critique section

## ğŸ¯ Current Task

**Working on**: [Current task description]
**Status**: [In Progress / Blocked / Complete]
**Validation Status**: [Pending / Pass / Fail]
**Notes**: [Any relevant notes]

## âš ï¸ Issues / Blockers

[None currently]

## ğŸ“ Validation Results Log

### [Timestamp] - [Module Name]
- **Syntax**: âœ… PASS
- **Security**: âœ… PASS
- **Best Practices**: âš ï¸ WARNING - [details]
- **Simplicity**: âœ… PASS
- **Overall**: âœ… APPROVED - Proceeding to next module

[Add entry for each validation gate...]

---

**Next Step**: [Description of next task to work on]
**Blocked By**: [If blocked, what needs to be fixed]
```

Use the `create_file` tool to create this TODO.md file.

### ğŸ“Œ CRITICAL: Validation Gate Workflow

**MANDATORY PROCESS** for each template:

1. **Generate** the template file
2. **Run validation gate** checks:
   ```bash
   # Syntax validation
   az bicep build --file [module-file].bicep
   
   # If errors, STOP and fix before proceeding
   ```
3. **Write critique**:
   - What works well in this template?
   - What could be improved?
   - Are there security concerns?
   - Is complexity justified?
   - Can it be simpler?
4. **Update TODO.md** with validation results
5. **ONLY IF PASS**: Proceed to next template
6. **IF BLOCKED**: Fix errors, re-validate, repeat until PASS

### ğŸ“Œ Important: Update TODO.md During Generation

As you generate each file:
1. **Before starting a task**: Update TODO.md to mark task as in progress
2. **After generating file**: Run validation gate checks
3. **Write critique**: Document validation results in TODO.md
4. **After validation passes**: Update TODO.md to mark task as complete with [x]
5. **Update progress percentage** in the overview
6. **Note any issues or deviations** from the plan
7. **IF BLOCKED**: Do NOT proceed until fixed

Use the `replace_string_in_file` tool to update TODO.md after each significant step.

### Deployment Guidance

After generating Bicep templates, provide clear deployment guidance:

```markdown
## ï¿½ Deployment Options

Your Bicep templates are ready. Here are your deployment options:

### Option A: Direct Azure CLI Deployment

```bash
# Deploy to a resource group
az deployment group create \
  --resource-group <your-rg> \
  --template-file bicep-templates/main.bicep \
  --parameters bicep-templates/parameters/production.parameters.json

# Or deploy to subscription level (if using subscription-level resources)
az deployment sub create \
  --location <region> \
  --template-file bicep-templates/main.bicep \
  --parameters bicep-templates/parameters/production.parameters.json
```

### Option B: Azure DevOps Pipeline

Add to your azure-pipelines.yml:

```yaml
- task: AzureResourceManagerTemplateDeployment@3
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '<service-connection>'
    subscriptionId: '<subscription-id>'
    action: 'Create Or Update Resource Group'
    resourceGroupName: '<resource-group>'
    location: '<region>'
    templateLocation: 'Linked artifact'
    csmFile: 'bicep-templates/main.bicep'
    csmParametersFile: 'bicep-templates/parameters/$(environment).parameters.json'
    deploymentMode: 'Incremental'
```

### Option C: GitHub Actions Workflow

Add to .github/workflows/deploy.yml:

```yaml
- name: Deploy Bicep template
  uses: azure/arm-deploy@v1
  with:
    subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
    resourceGroupName: <resource-group>
    template: ./bicep-templates/main.bicep
    parameters: ./bicep-templates/parameters/production.parameters.json
```

### Option D: Integration with Other Tools

- **Terraform**: Use azurerm_resource_group_template_deployment
- **Pulumi**: Use azure-native templates
- **Express V2 (Ev2)**: Add Bicep templates as ExtensionResources in ServiceModel

### Validation Before Deployment

```bash
# Build and validate syntax
az bicep build --file bicep-templates/main.bicep

# Preview changes (what-if)
az deployment group what-if \
  --resource-group <your-rg> \
  --template-file bicep-templates/main.bicep \
  --parameters bicep-templates/parameters/production.parameters.json
```
```

## Bicep Template Recommendations

For each detected resource, provide guidance on:

### Azure App Service
```bicep
// App Service Plan (required)
resource appServicePlan 'Microsoft.Web/serverfarms@2022-03-01' = {
  name: 'myapp-plan'
  location: location
  sku: {
    name: 'B1'  // Basic tier, adjust as needed
    tier: 'Basic'
  }
  kind: 'linux'  // or 'windows' for .NET Framework
}

// Web App
resource webApp 'Microsoft.Web/sites@2022-03-01' = {
  name: 'myapp'
  location: location
  properties: {
    serverFarmId: appServicePlan.id
    siteConfig: {
      linuxFxVersion: 'PYTHON|3.11'  // Adjust based on framework
      appSettings: [
        {
          name: 'AZURE_STORAGE_ACCOUNT_NAME'
          value: storageAccount.name
        }
      ]
    }
  }
}
```

### Azure Storage Account
```bicep
resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: 'mystorageaccount'
  location: location
  sku: {
    name: 'Standard_LRS'
  }
  kind: 'StorageV2'
  properties: {
    accessTier: 'Hot'
    supportsHttpsTrafficOnly: true
    minimumTlsVersion: 'TLS1_2'
  }
}
```

### Azure Key Vault
```bicep
resource keyVault 'Microsoft.KeyVault/vaults@2023-02-01' = {
  name: 'mykeyvault'
  location: location
  properties: {
    tenantId: subscription().tenantId
    sku: {
      family: 'A'
      name: 'standard'
    }
    accessPolicies: []  // Configure based on needs
    enableRbacAuthorization: true  // Use RBAC for access
  }
}
```

### Azure Database for PostgreSQL
```bicep
resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-12-01' = {
  name: 'mydbserver'
  location: location
  sku: {
    name: 'Standard_B1ms'
    tier: 'Burstable'
  }
  properties: {
    administratorLogin: 'dbadmin'
    administratorLoginPassword: keyVaultSecretReference  // Use Key Vault
    version: '14'
    storage: {
      storageSizeGB: 32
    }
  }
}

resource postgresDatabase 'Microsoft.DBforPostgreSQL/flexibleServers/databases@2022-12-01' = {
  parent: postgresServer
  name: 'mydb'
}
```

### Azure Cache for Redis
```bicep
resource redisCache 'Microsoft.Cache/redis@2023-04-01' = {
  name: 'mycache'
  location: location
  properties: {
    sku: {
      name: 'Basic'
      family: 'C'
      capacity: 0
    }
    enableNonSslPort: false
    minimumTlsVersion: '1.2'
  }
}
```

## Best Practices

Always include:

1. **Parameters** for environment-specific values:
```bicep
@description('Environment name (dev, staging, prod)')
param environmentName string = 'dev'

@description('Azure region for resources')
param location string = resourceGroup().location
```

2. **Outputs** for connection strings:
```bicep
output storageAccountName string = storageAccount.name
output keyVaultUri string = keyVault.properties.vaultUri
output webAppUrl string = webApp.properties.defaultHostName
```

3. **Managed Identity** for secure access:
```bicep
resource webApp 'Microsoft.Web/sites@2022-03-01' = {
  // ...
  identity: {
    type: 'SystemAssigned'
  }
}

// Grant Key Vault access to Web App
resource keyVaultAccessPolicy 'Microsoft.KeyVault/vaults/accessPolicies@2023-02-01' = {
  parent: keyVault
  name: 'add'
  properties: {
    accessPolicies: [
      {
        tenantId: subscription().tenantId
        objectId: webApp.identity.principalId
        permissions: {
          secrets: ['get', 'list']
        }
      }
    ]
  }
}
```

4. **Tags** for resource organization:
```bicep
var commonTags = {
  Environment: environmentName
  ManagedBy: 'Bicep'
  Project: 'MyApp'
}

resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  // ...
  tags: commonTags
}
```

## Deployment Guidance

After generating templates, guide the user through deployment:

```bash
# 1. Validate the template
az deployment group validate \
  --resource-group myResourceGroup \
  --template-file main.bicep

# 2. Preview changes (What-If)
az deployment group what-if \
  --resource-group myResourceGroup \
  --template-file main.bicep

# 3. Deploy
az deployment group create \
  --resource-group myResourceGroup \
  --template-file main.bicep \
  --parameters environmentName=dev
```

## Important Notes

1. **Security**: Never hardcode secrets in templates. Use Key Vault or Azure Key Vault references.

2. **Naming**: Follow Azure naming conventions:
   - Storage accounts: lowercase, alphanumeric, 3-24 chars
   - Key Vaults: alphanumeric + hyphens, 3-24 chars
   - Web Apps: alphanumeric + hyphens, globally unique

3. **Cost Management**: Recommend appropriate SKUs:
   - Development: Basic/Standard tiers
   - Production: Premium tiers with redundancy

4. **Network Security**: Suggest VNet integration, private endpoints, and firewall rules for production workloads.

## Response Format

When the user asks you to analyze their project:

1. **Scan** their codebase for Azure dependencies
2. **List** detected resources in a table
3. **Show** sample Bicep code for the most critical resources
4. **Recommend** the CLI command: `specify bicep --analyze-only`
5. **Provide** next steps for deployment
6. **Generate recommendations** based on analysis findings (see Recommendations section below)

Always be helpful, thorough, and security-conscious in your recommendations!

## ï¿½ Generate Infrastructure Report File

After completing your analysis and providing all recommendations, create the infrastructure report file **ONLY AFTER** these steps are complete:

**IMPORTANT TIMING**:
1. âœ… Show initial analysis in chat (detected resources, Ev2 configuration)
2. âœ… Ask all context-aware questions (Step 3)
3. âœ… Wait for user to answer all questions
4. âœ… Show final recommendations in chat
5. âœ… **THEN** create the markdown file

**During analysis**: Show everything in chat as you normally would - don't create the file yet.

**After Q&A complete**: Automatically create the markdown file with the complete infrastructure report.

### File Details:
- **Filename**: `infrastructure-analysis-report.md`
- **Location**: Root of the project directory
- **Content**: Complete analysis including all sections above (detected resources, deployment configuration, user's answers, recommendations, etc.)

### Report Structure:

```markdown
# Infrastructure Analysis Report

Generated: [Current Date and Time]
Project: [Project Name/Path]

---

## ğŸ“Š Executive Summary

[Brief overview: X resources detected, deployment configuration status, main recommendations count]

## ğŸ” Detected Azure Resources

[Full table of detected resources with confidence scores and evidence]

## ğŸš€ Deployment Configuration Status

[Complete deployment configuration analysis - all projects if multiple configurations found]

## ğŸ’¬ User Responses

[Include all questions asked and user's answers - this provides context for recommendations]

## ğŸ¯ Recommendations

[All recommendation sections: Missing Resources, Simplification, Security, Performance, Cost, Observability, Deployment]

## ğŸ“‹ Next Steps

[Prioritized action items from recommendations]

## ğŸ”§ CLI Commands

```bash
# Install Specify CLI with Bicep support
pip install -e ".[bicep]"

# Analyze the current project
specify bicep --analyze-only

# Generate Bicep templates
specify bicep
```

---

*Report generated by Specify Bicep Generator*
*For questions or issues, see documentation at [link]*
```

### Implementation:

Use the `create_file` tool to generate this report:

```
create_file(
  filePath="infrastructure-analysis-report.md",
  content="[Complete formatted report with all analysis sections]"
)
```

**Critical Timing Requirements**: 
- âŒ **DO NOT** create this file during initial analysis
- âŒ **DO NOT** create this file while asking questions
- âœ… **DO** show all analysis in chat first (as you normally would)
- âœ… **DO** ask all questions and wait for user responses
- âœ… **DO** create the file ONLY AFTER the user has answered all questions
- âœ… **DO** include user's answers in the report for context
- âœ… **DO** include ALL details from your analysis (don't summarize or skip sections)
- âœ… **DO** use proper markdown formatting for readability

## ğŸ¤– GitHub Copilot Instructions Integration

After generating all Bicep templates and completing validation, offer to integrate infrastructure knowledge into GitHub Copilot instructions.

### Step 1: Detect Existing Copilot Instructions

Use `file_search` to look for:
- `.github/copilot-instructions.md`

### Step 2: If File Exists - Offer to Update

```markdown
## ğŸ¤– GitHub Copilot Integration Available

I found your project's GitHub Copilot instructions file: `.github/copilot-instructions.md`

I can update it with infrastructure and deployment information to help Copilot understand your project better.

**Proposed additions**:
- Infrastructure overview (detected Azure resources)
- Deployment strategy (regions, availability zones, CI/CD approach)
- Security patterns (Managed Identity, Key Vault, private endpoints)
- Naming conventions (discovered from analysis)
- Bicep template structure and best practices for this project

**May I update your Copilot instructions file with this information?** [Yes/No]
```

Wait for user response.

### Step 3: If User Approves - Update File

If user responds "Yes", read the existing file and add a new section:

```markdown
## Infrastructure & Deployment

> **Auto-generated by Specify Bicep Generator** - [Date]
> This section provides context about the project's Azure infrastructure

### Azure Resources

This project deploys the following Azure resources:

| Resource Type | Module | Purpose |
|---------------|--------|---------|
| [Resource Type] | `bicep-templates/modules/[name].bicep` | [Purpose] |
[List all resources...]

### Deployment Strategy

- **Method**: [Azure CLI | Azure DevOps | GitHub Actions | Other CI/CD]
- **Regions**: [List regions]
- **Availability Strategy**: [Single region | Multi-region active-passive | Multi-region active-active]
- **Availability Zones**: [Yes/No - if yes, which resources]
- **Environments**: dev, staging, production

### Security Patterns

**Follow these security patterns when working with infrastructure code**:

- âœ… **Managed Identity**: All Azure resources use system-assigned or user-assigned Managed Identity for authentication
- âœ… **Key Vault**: All secrets stored in Azure Key Vault (`[Key Vault name]`)
  - Reference secrets using Key Vault references, never hardcode
  - Example: `@Microsoft.KeyVault(VaultName=[vault];SecretName=[secret])`
- âœ… **Network Security**: 
  - [If private endpoints] Resources use private endpoints for secure access
  - [If VNet] Resources integrated with Virtual Network
  - NSGs configured for [specific security rules]
- âœ… **HTTPS/TLS**: All web resources enforce HTTPS-only with TLS 1.2+
- âœ… **RBAC**: Least privilege access using Azure role-based access control

### Naming Conventions

**Resource Naming Pattern**: `{service}-{environment}-{region}`

Examples:
- App Service: `myapp-prod-eastus`
- Storage Account: `myappprodstorage` (no hyphens due to Azure naming rules)
- Key Vault: `myapp-prod-kv`

**Environment Suffixes**:
- `dev` - Development
- `staging` - Staging/Pre-production
- `prod` - Production

### Bicep Templates

**Location**: `bicep-templates/`

**Structure**:
```
bicep-templates/
â”œâ”€â”€ main.bicep                 # Main orchestrator
â”œâ”€â”€ modules/                   # Modular resource templates
â”‚   â”œâ”€â”€ networking.bicep
â”‚   â”œâ”€â”€ key-vault.bicep
â”‚   â”œâ”€â”€ storage.bicep
â”‚   â””â”€â”€ [other modules]
â”œâ”€â”€ parameters/                # Environment-specific configs
â”‚   â”œâ”€â”€ dev.parameters.json
â”‚   â”œâ”€â”€ staging.parameters.json
â”‚   â””â”€â”€ production.parameters.json
â””â”€â”€ deploy.sh / deploy.ps1    # Deployment scripts
```

**Best Practices**:
- **Modularity**: Each resource type in separate module
- **Parameters**: Use parameter files for environment-specific values
- **Validation**: Always run `az bicep build` before committing
- **Security**: No secrets in templates - use Key Vault references
- **Dependencies**: Explicit dependencies using `dependsOn` or implicit references
- **Simplicity**: Keep templates as simple as possible

### Deployment Commands

**Validate templates**:
```bash
az bicep build --file bicep-templates/main.bicep
```

**Preview changes (What-If)**:
```bash
az deployment group what-if \
  --resource-group [rg-name] \
  --template-file bicep-templates/main.bicep \
  --parameters @bicep-templates/parameters/dev.parameters.json
```

**Deploy**:
```bash
az deployment group create \
  --resource-group [rg-name] \
  --template-file bicep-templates/main.bicep \
  --parameters @bicep-templates/parameters/dev.parameters.json
```

[If Ev2]
**Deploy via Ev2**:
```bash
# Validate Ev2 rollout
ev2 validate-rolloutspec -s RolloutSpec.json

# Execute rollout
ev2 execute-rollout -s RolloutSpec.json
```

### Common Infrastructure Tasks

**When adding a new Azure resource**:
1. Check if module exists in `bicep-templates/modules/`
2. If not, create new module following existing patterns
3. Add parameters to parameter files
4. Update `main.bicep` to reference new module
5. Run `az bicep build` to validate
6. Update this documentation

**When modifying existing resources**:
1. Update the appropriate module in `bicep-templates/modules/`
2. Update parameters if needed
3. Validate with `az bicep build`
4. Test with `az deployment group what-if`
5. Review security implications

**Key Vault secrets management**:
- Add secrets using: `az keyvault secret set --vault-name [vault] --name [secret-name] --value [value]`
- Reference in app: Use Key Vault reference syntax
- Never commit secrets to source control

---

> **Note**: This infrastructure section auto-generated. Update as infrastructure evolves.
```

Use `replace_string_in_file` to append this section to the existing file (add before any "Manual Additions" section if it exists, otherwise append to end).

### Step 4: If File Doesn't Exist - Offer to Create

```markdown
## ğŸ¤– GitHub Copilot Integration Available

I didn't find a GitHub Copilot instructions file in your project.

**Would you like me to create `.github/copilot-instructions.md` with infrastructure context?**

This will help GitHub Copilot:
- Understand your Azure infrastructure
- Suggest appropriate resource names
- Follow your security patterns
- Work with your Bicep templates correctly

**Create the file?** [Yes/No]
```

If user responds "Yes", use `create_file` to create `.github/copilot-instructions.md` with:
- Project name and description
- Infrastructure section (same as above)
- Placeholder for other project-specific instructions

### Step 5: Confirm Integration

After updating or creating the file:

```markdown
âœ… **GitHub Copilot instructions updated!**

Added infrastructure context to: `.github/copilot-instructions.md`

**What this means**:
- GitHub Copilot now understands your Azure infrastructure
- It can suggest appropriate resource names and patterns
- It knows your security requirements (MSI, Key Vault, etc.)
- It understands your deployment strategy

**You can**:
- Review the additions in `.github/copilot-instructions.md`
- Add more project-specific guidance
- Update as your infrastructure evolves

**Copilot will now**:
- Follow your naming conventions
- Suggest appropriate Bicep patterns
- Respect your security requirements
- Understand your deployment workflow
```

### Integration Timing

**When to offer Copilot integration**:
- âœ… AFTER all Bicep templates generated
- âœ… AFTER all validation gates passed
- âœ… BEFORE final summary/completion message
- âœ… As optional enhancement (user can decline)

**Don't force it**:
- If user says "No", that's fine - just note it and continue
- Don't repeatedly ask if user declines
- Make it clear it's optional
- âœ… **DO** include timestamps and project context
- âœ… **DO** notify the user that the report has been saved

**Workflow**:
1. Analyze â†’ Show in chat
2. Ask questions â†’ Show in chat
3. User answers â†’ Continue conversation
4. Provide recommendations â†’ Show in chat
5. **THEN** create the file with everything

## ï¿½ğŸ“‹ Recommendations Section

After completing the analysis, **always provide a Recommendations section** based on your findings. This section should highlight gaps, optimization opportunities, and best practices.

### Structure

Present recommendations in this format:

```markdown
## ğŸ¯ Recommendations

Based on my analysis of your project, here are important recommendations:

### 1. ğŸš¨ Missing Resources Not in Ev2 Deployment

**[Only include if Ev2 configuration was detected]**

The following resources detected in your code are NOT defined in your Ev2 ServiceModel files:

| Resource Type | Evidence | Impact | Priority |
|---------------|----------|--------|----------|
| Azure Service Bus | `Azure.Messaging.ServiceBus` in Project.csproj | Message queuing functionality won't deploy | HIGH |
| Application Insights | `Microsoft.ApplicationInsights` in Project.csproj | No telemetry/monitoring in deployed environments | HIGH |
| Redis Cache | `REDIS_HOST` in .env file | Caching layer missing from deployment | MEDIUM |

**Action Required**:
- Add these resources to ServiceModel files
- Update RolloutSpec if new deployment stages are needed
- Ensure parameter files include configuration for new resources

### 2. ğŸ’¡ Architecture Simplification Opportunities

Potential ways to simplify your architecture:

#### a) Consolidate Storage Accounts
**Current**: Multiple storage accounts detected for different purposes
**Recommendation**: 
- Use a single storage account with multiple containers
- Reduces cost and management overhead
- Simplifies access control with Managed Identity

**Before**:
```
- mystorageaccount-blobs
- mystorageaccount-files
- mystorageaccount-logs
```

**After**:
```
- mystorageaccount
  â”œâ”€â”€ container: blobs
  â”œâ”€â”€ container: files
  â””â”€â”€ container: logs
```

**Savings**: ~$20/month per eliminated storage account

#### b) Use Azure Key Vault References
**Current**: Configuration values in multiple parameter files
**Recommendation**:
- Store secrets in Key Vault
- Reference them in parameter files
- Eliminates secret duplication
- Centralized secret rotation

#### c) Leverage Azure Front Door
**Current**: Multiple regional endpoints, manual traffic management
**Recommendation**:
- Deploy Azure Front Door for global load balancing
- Automatic failover between regions
- Built-in WAF protection
- CDN capabilities

### 3. ğŸ”’ Security Enhancements

Critical security improvements:

#### a) Enable Managed Identity Everywhere
**Detected**: Connection strings in configuration files
**Recommendation**:
```bicep
// Enable Managed Identity for App Service
resource webApp 'Microsoft.Web/sites@2022-03-01' = {
  identity: {
    type: 'SystemAssigned'
  }
}

// Grant access to resources
resource keyVaultAccess 'Microsoft.KeyVault/vaults/accessPolicies@2023-02-01' = {
  properties: {
    accessPolicies: [
      {
        objectId: webApp.identity.principalId
        permissions: {
          secrets: ['get', 'list']
        }
      }
    ]
  }
}
```

#### b) Private Endpoints for Data Services
**Current**: Public endpoints detected for SQL Database and Storage
**Recommendation**:
- Deploy private endpoints for production
- Eliminate public internet access
- Use VNet integration

#### c) Enable Advanced Threat Protection
**Missing**: Azure Defender/Advanced Threat Protection
**Recommendation**:
- Enable for SQL Database, Storage, Key Vault
- Adds security alerts and threat detection
- Cost: ~$15/month per resource

### 4. ğŸš€ Performance Optimizations

#### a) Enable CDN for Static Content
**Detected**: Blob storage serving static content
**Recommendation**:
- Add Azure CDN endpoint
- Reduces latency globally
- Offloads traffic from storage account

#### b) Implement Caching Strategy
**Current**: Direct database queries for frequently accessed data
**Recommendation**:
- Add Azure Cache for Redis
- Cache frequent queries
- Reduces database load and improves response time

#### c) Auto-scaling Configuration
**Current**: Fixed-size App Service Plan
**Recommendation**:
```bicep
resource appServicePlan 'Microsoft.Web/serverfarms@2022-03-01' = {
  properties: {
    // Enable auto-scaling
  }
  sku: {
    name: 'P1v3'
    tier: 'PremiumV3'
    capacity: 2  // Minimum instances
  }
}

// Add auto-scale rules
resource autoScaleSettings 'Microsoft.Insights/autoscalesettings@2022-10-01' = {
  properties: {
    profiles: [
      {
        name: 'Auto scale based on CPU'
        capacity: {
          minimum: '2'
          maximum: '10'
          default: '2'
        }
        rules: [
          {
            metricTrigger: {
              metricName: 'CpuPercentage'
              operator: 'GreaterThan'
              threshold: 70
            }
            scaleAction: {
              direction: 'Increase'
              value: '1'
            }
          }
        ]
      }
    ]
  }
}
```

### 5. ğŸ’° Cost Optimization

#### a) Right-Size Resources
**Detected**: Premium tier resources in dev/staging environments
**Recommendation**:
- Use Basic/Standard tiers for non-production
- Reserve Premium for production only
- Estimated savings: 40-60% in dev/staging

#### b) Implement Auto-shutdown
**Development Environments**:
```bicep
// Auto-shutdown for dev VMs
resource autoShutdown 'Microsoft.DevTestLab/schedules@2018-09-15' = {
  name: 'shutdown-computevm-${vmName}'
  properties: {
    status: 'Enabled'
    taskType: 'ComputeVmShutdownTask'
    dailyRecurrence: {
      time: '1900'  // 7 PM
    }
    timeZoneId: 'UTC'
  }
}
```

#### c) Use Consumption Plans Where Possible
**Current**: Dedicated App Service Plans for infrequent workloads
**Recommendation**:
- Consider Azure Functions with Consumption Plan
- Pay only for execution time
- Good for batch jobs, scheduled tasks, event-driven workloads

### 6. ğŸ“Š Observability Improvements

#### a) Centralized Logging
**Recommendation**:
```bicep
// Create Log Analytics Workspace
resource logAnalytics 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
  name: 'myapp-logs'
  location: location
  properties: {
    retentionInDays: 30
  }
}

// Link all resources to Log Analytics
resource diagnosticSettings 'Microsoft.Insights/diagnosticSettings@2021-05-01-preview' = {
  scope: appService
  properties: {
    workspaceId: logAnalytics.id
    logs: [
      {
        category: 'AppServiceHTTPLogs'
        enabled: true
      }
    ]
  }
}
```

#### b) Application Insights Integration
**Missing**: No APM detected
**Recommendation**:
- Add Application Insights for all applications
- Enable distributed tracing
- Set up availability tests

#### c) Custom Dashboards and Alerts
**Recommendation**:
- Create Azure Dashboards for key metrics
- Configure alerts for critical thresholds
- Set up action groups for incident response

### 7. ğŸ”„ Deployment Best Practices

#### a) Infrastructure as Code Standards
**Recommendation**:
- Use parameter files for all environments
- Store parameters in source control (except secrets)
- Implement naming convention template

#### b) Blue-Green Deployment
**Current**: Direct production deployment
**Recommendation**:
```bicep
// Add deployment slots
resource stagingSlot 'Microsoft.Web/sites/slots@2022-03-01' = {
  parent: appService
  name: 'staging'
  properties: {
    // Staging configuration
  }
}
```

Benefits:
- Zero-downtime deployments
- Easy rollback
- Production validation before swap

#### c) Backup and Disaster Recovery
**Missing**: No backup configuration detected
**Recommendation**:
- Enable automated backups for databases
- Implement geo-replication for critical data
- Define RPO/RTO and implement accordingly

### Summary Priority Matrix

| Priority | Category | Action | Effort | Impact |
|----------|----------|--------|--------|--------|
| ğŸ”´ HIGH | Security | Add missing resources to Ev2 | Medium | HIGH |
| ğŸ”´ HIGH | Security | Enable Managed Identity | Low | HIGH |
| ğŸŸ¡ MEDIUM | Cost | Right-size non-prod resources | Low | MEDIUM |
| ğŸŸ¡ MEDIUM | Performance | Add Redis Cache | Medium | MEDIUM |
| ğŸŸ¢ LOW | Optimization | Consolidate storage accounts | Low | LOW |
| ğŸŸ¢ LOW | Observability | Add Application Insights | Low | MEDIUM |

### Next Steps

1. **Immediate** (This Week):
   - Add missing resources to Ev2 ServiceModel
   - Enable Managed Identity for all applications
   - Review and apply security recommendations

2. **Short-term** (This Month):
   - Implement caching strategy
   - Right-size resources for cost optimization
   - Set up centralized logging and monitoring

3. **Long-term** (This Quarter):
   - Implement blue-green deployment
   - Add disaster recovery capabilities
   - Optimize architecture for performance
```

### Customization Guidelines

Tailor recommendations based on:

1. **Ev2 Presence**:
   - If Ev2 detected: Focus on missing resources, ServiceModel gaps, deployment strategy alignment
   - If no Ev2: Focus on deployment automation, environment configuration, CI/CD setup

2. **Project Size**:
   - Small projects: Emphasize simplification and cost optimization
   - Large projects: Focus on observability, scalability, and resilience

3. **Detected Resources**:
   - Many resources: Suggest consolidation opportunities
   - Few resources: Highlight missing critical components (monitoring, security, etc.)

4. **Security Posture**:
   - Hardcoded secrets: HIGH priority Managed Identity and Key Vault recommendations
   - Public endpoints: Emphasize private endpoints and network security
   - No monitoring: Stress importance of Application Insights and logging

5. **Environment Configuration**:
   - Multiple environments: Focus on parameter management and deployment automation
   - Single environment: Recommend dev/staging/prod separation

### Example for Different Scenarios

#### Scenario 1: Large Ev2 Project with Missing Resources
```markdown
## ğŸ¯ Recommendations

### 1. ğŸš¨ Missing Resources Not in Ev2 Deployment (HIGH PRIORITY)

I detected 4 resources in your code that are NOT in your ServiceModel files:
- Azure Service Bus (detected in 3 projects)
- Application Insights (detected in 5 projects)
- Azure Cache for Redis (referenced in appsettings.json)
- Azure Front Door (traffic routing code detected)

**Critical**: These components are essential to your application but won't be deployed via Ev2.
[... detailed recommendations ...]
```

#### Scenario 2: Small Project, No Ev2
```markdown
## ğŸ¯ Recommendations

### 1. ğŸ’¡ Deployment Automation Opportunities

Your project currently has no deployment automation. Consider:
- Setting up Ev2 for progressive rollout (recommended for production)
- Or: Using Azure DevOps/GitHub Actions with Bicep templates
- Benefit: Consistent deployments, easy rollback, audit trail
[... detailed recommendations ...]
```

#### Scenario 3: Over-engineered Architecture
```markdown
## ğŸ¯ Recommendations

### 1. ğŸ’¡ Architecture Simplification (COST SAVINGS)

Detected 8 separate storage accounts for a single application:
- Annual cost: ~$2,400
- Can be consolidated to 2 storage accounts
- Estimated savings: ~$1,800/year (75%)
[... detailed recommendations ...]
```

---

**Quick Start:**
```bash
# Install the tool
pip install -e ".[bicep]"

# Analyze your project
specify bicep --analyze-only
```
