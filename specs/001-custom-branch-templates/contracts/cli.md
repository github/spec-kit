# CLI Contract: specify init --settings

**Feature**: 001-custom-branch-templates  
**Date**: 2026-01-23

## Command Interface

### `specify init --settings`

Generate a settings file with documented template options.

**Synopsis**:
```
specify init --settings [--force]
```

**Options**:

| Option | Type | Required | Description |
|--------|------|----------|-------------|
| `--settings` | flag | Yes | Generate settings file instead of initializing project |
| `--force` | flag | No | Overwrite existing settings file without prompting |

**Behavior**:

1. Check if `.specify/settings.toml` exists
2. If exists and `--force` not provided:
   - Prompt: "Settings file already exists. Overwrite? [y/N]"
   - Exit if user declines
3. Create `.specify/` directory if not exists
4. Write settings template to `.specify/settings.toml`
5. Print success message with file path

**Output (success)**:
```
✓ Created settings file: .specify/settings.toml
  Edit the branch.template setting to customize branch naming.
```

**Output (exists, no force)**:
```
Settings file already exists: .specify/settings.toml
Use --force to overwrite.
```

**Exit Codes**:

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | User declined overwrite |
| 2 | Write error |

---

## Shell Script Contracts

### `create-new-feature.sh` / `create-new-feature.ps1`

**New Behavior**:

1. Check for `.specify/settings.toml`
2. If exists, read `branch.template` value
3. If not exists or key missing, use default `{number}-{short_name}`
4. Resolve template variables in order:
   - `{username}` → Git user.name (normalized) → OS username fallback
   - `{email_prefix}` → Git user.email prefix
   - `{number}` → Next available (scoped to prefix)
   - `{short_name}` → From `--short-name` or generated from description
5. Validate resolved branch name
6. Create branch and spec directory

**New Functions (Bash)**:

```bash
# Load branch template from settings file
# Returns: template string or empty if not found
load_branch_template() {
    local settings_file="$REPO_ROOT/.specify/settings.toml"
    if [ -f "$settings_file" ]; then
        grep -E '^template\s*=' "$settings_file" | sed 's/.*=\s*"\([^"]*\)".*/\1/' | head -1
    fi
}

# Resolve {username} variable
# Returns: normalized username
resolve_username() {
    local username
    username=$(git config user.name 2>/dev/null || echo "")
    if [ -z "$username" ]; then
        username="${USER:-unknown}"
    fi
    echo "$username" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/-\+/-/g' | sed 's/^-//' | sed 's/-$//'
}

# Resolve {email_prefix} variable
# Returns: email prefix (before @)
resolve_email_prefix() {
    local email
    email=$(git config user.email 2>/dev/null || echo "")
    echo "${email%%@*}" | tr '[:upper:]' '[:lower:]'
}

# Get highest number for a specific prefix
# Args: $1 = prefix pattern (e.g., "johndoe/")
get_highest_for_prefix() {
    local prefix="$1"
    # ... filter branches matching prefix, find max number
}

# Validate branch name against Git rules
# Args: $1 = branch name
# Returns: 0 if valid, 1 if invalid (prints error)
validate_branch_name() {
    local name="$1"
    # ... check all Git branch naming rules
}
```

**New Functions (PowerShell)**:

```powershell
function Get-BranchTemplate {
    param([string]$RepoRoot)
    $settingsFile = Join-Path $RepoRoot '.specify/settings.toml'
    if (Test-Path $settingsFile) {
        $content = Get-Content $settingsFile -Raw
        if ($content -match 'template\s*=\s*"([^"]*)"') {
            return $matches[1]
        }
    }
    return $null
}

function Resolve-Username {
    $username = git config user.name 2>$null
    if (-not $username) {
        $username = $env:USERNAME
    }
    return ($username.ToLower() -replace '[^a-z0-9]', '-' -replace '-+', '-' -replace '^-|-$', '')
}

function Resolve-EmailPrefix {
    $email = git config user.email 2>$null
    if ($email -match '^([^@]+)') {
        return $matches[1].ToLower()
    }
    return ''
}

function Get-HighestNumberForPrefix {
    param([string]$Prefix)
    # ... filter branches matching prefix, find max number
}

function Test-BranchName {
    param([string]$Name)
    # ... check all Git branch naming rules
}
```

---

## Settings File Template

Generated by `specify init --settings`:

```toml
# Spec Kit Settings
# Documentation: https://github.github.io/spec-kit/

[branch]
# Template for generating feature branch names.
#
# Available variables:
#   {number}       - Auto-incrementing 3-digit feature number (001, 002, ...)
#   {short_name}   - Generated or provided short feature name
#   {username}     - Git user.name, normalized for branch names
#   {email_prefix} - Portion of Git user.email before the @ symbol
#
# Examples:
#   "{number}-{short_name}"                      # 001-add-login (default, solo dev)
#   "{username}/{number}-{short_name}"           # johndoe/001-add-login (team)
#   "feature/{username}/{number}-{short_name}"  # feature/johndoe/001-add-login
#   "users/{email_prefix}/{number}-{short_name}" # users/jsmith/001-add-login
#
# When using {username} or a static prefix, each prefix gets its own number
# sequence to avoid conflicts between team members.

template = "{number}-{short_name}"
```
