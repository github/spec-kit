---
description: Orchestrate the end-to-end specification workflow (specify → clarify → plan → tasks → analyze) and produce a consolidated status report.
---

## Strict Contract

- **Required Inputs**
  - `$ARGUMENTS` must include the feature description when bootstrapping a new feature; may be omitted for follow-up runs.
  - Must load `/memory/constitution.md` and existing artifacts when present.
- **Allowed Tools**
  - Execute the same scripts used by the individual commands in the following order:
    1. `scripts/bash/create-new-feature.sh --json` or `scripts/powershell/create-new-feature.ps1 -Json`
    2. `scripts/bash/check-prerequisites.sh --json --paths-only` / PowerShell equivalent for clarification
    3. `scripts/bash/setup-plan.sh --json` / PowerShell equivalent
    4. `scripts/bash/check-prerequisites.sh --json` / PowerShell equivalent for tasks
    5. `scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks` / PowerShell equivalent for analyze
  - Read and write files inside the feature directory as required by each phase.
  - Invoke `scripts/bash/update-agent-context.sh` / `scripts/powershell/update-agent-context.ps1` after planning.
- **Outputs**
  - Persist artifacts generated by each phase (`spec.md`, checklists, `plan.md`, `research.md`, `data-model.md`, `contracts/`, `quickstart.md`, `tasks.md`).
  - Emit a single JSON code block summarizing stage outcomes:

    ```json
    {
      "status": "success" | "error",
      "branch": "<branch-name>",
      "phases": {
        "specify": "pass" | "fail",
        "clarify": "pass" | "pending",
        "plan": "pass" | "fail",
        "tasks": "pass" | "fail",
        "analyze": "pass" | "fail"
      },
      "artifacts": {
        "spec": "<path>",
        "plan": "<path>",
        "tasks": "<path>"
      },
      "alerts": ["<issue>", "..."],
      "next_steps": ["<recommended action>"]
    }
    ```

- **Idempotency**
  - Re-running should detect existing artifacts and skip redundant regeneration unless inputs changed.
- **Stop Conditions**
  - Abort (set `status = error`) on unrecoverable failures (e.g., unresolved `[NEEDS CLARIFICATION]`, constitution gate failures).
  - Terminate after emitting JSON; do not prompt for additional interaction beyond clarification questions handled in-phase.

## Execution Flow

1. **Specification Phase**
   - Run the feature creation script (Bash or PowerShell). Shell guidance:
     - **Bash**: Use double quotes for arguments; escape embedded quotes with `\"`.
     - **PowerShell**: Use double quotes and escape embedded quotes by doubling them.
   - Follow the `/speckit.specify` rules to populate `spec.md` and `checklists/requirements.md`, limiting to three `[NEEDS CLARIFICATION]` markers.

2. **Clarification Phase**
   - If `[NEEDS CLARIFICATION]` markers remain, use the clarification script to locate `spec.md` and ask targeted questions one at a time per the `/speckit.clarify` workflow.
   - Update `spec.md` and the Clarifications History table with resolved answers.
   - Mark phase as `pending` if questions remain unanswered when the command ends.

3. **Planning Phase**
   - Run the plan setup script to obtain template paths.
   - Populate `plan.md`, `research.md`, `data-model.md`, `quickstart.md`, and `contracts/` according to the `/speckit.plan` prompt, enforcing constitution gates and updating agent context files.
   - Fail the phase if any gate remains `FAIL`.

4. **Task Generation Phase**
   - Execute the prerequisite script (without `--require-tasks`) to gather context.
   - Generate `tasks.md` using the `/speckit.tasks` rules: machine-parseable task IDs, dependency registry, Mermaid graph, and Definition of Done checklists.
   - Validate coverage between requirements and tasks.

5. **Analysis Phase**
   - Run the prerequisite script with `--require-tasks --include-tasks` to gather artifact paths.
   - Perform the `/speckit.analyze` checks in read-only mode and collect findings for the final report.

6. **Consolidated Report**
   - For each phase, record `pass`, `fail`, or `pending` status along with key alerts (e.g., unresolved clarifications, dependency violations).
   - Populate the JSON summary with artifact paths and recommended next steps (e.g., rerun clarify, address gate failures).
