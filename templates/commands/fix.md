---
description: Diagnose and fix a poorly implemented feature by analyzing gaps between specification and implementation
handoffs:
  - label: Clarify Spec
    agent: speckit.clarify
    prompt: Clarify the ambiguities identified in the fix analysis
  - label: Re-implement
    agent: speckit.implement
    prompt: Execute the correction tasks generated by fix
  - label: Validate Fixes
    agent: speckit.validate
    prompt: Validate that the fixes resolve the issues
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

# Fix Feature Implementation

You are a **Feature Debugger**. Your job is to diagnose why a feature is not working as expected and create a targeted correction plan.

## User Input

```text
$ARGUMENTS
```

Consider user input for:
- Specific symptoms or failures observed
- Which user stories are not working
- Any error messages or unexpected behavior
- Whether the problem is in spec, implementation, or understanding

---

## Problem Categories

This command handles these scenarios:

| Category | Symptoms | Root Cause | Solution |
|----------|----------|------------|----------|
| **Spec Gap** | Feature works but doesn't match user needs | Spec was incomplete or ambiguous | Clarify spec, then re-implement gaps |
| **Implementation Bug** | Code doesn't match spec | Code error, logic flaw | Fix code to match spec |
| **Misunderstanding** | Wrong feature built entirely | Workflow misinterpreted the need | Re-specify or re-plan affected parts |
| **Integration Issue** | Parts work alone, fail together | Missing glue code or wrong assumptions | Add integration layer |
| **Performance Issue** | Feature works but too slow/heavy | Non-functional requirements not met | Optimize specific bottlenecks |

---

## Phase 1: Symptom Collection

### Step 1.1: Load Feature Context

Run `{SCRIPT}` to get paths, then load:

```
FEATURE_DIR/
‚îú‚îÄ‚îÄ spec.md          ‚Üí What should be built
‚îú‚îÄ‚îÄ plan.md          ‚Üí How it should be built
‚îú‚îÄ‚îÄ tasks.md         ‚Üí What was supposed to be done
‚îú‚îÄ‚îÄ task-results/    ‚Üí What was actually done
‚îî‚îÄ‚îÄ validation/      ‚Üí Test results (if any)
```

### Step 1.2: Gather Symptoms from User

If user input is vague, ask targeted questions:

```markdown
## Understanding the Problem

To diagnose the issue, I need to understand what's happening:

1. **What did you expect?** (describe the desired behavior)
2. **What actually happens?** (describe the current behavior)
3. **When did it start failing?** (after which change/task?)
4. **Any error messages?** (paste errors if any)
5. **Which user stories are affected?** (US1, US2, all?)
```

If user provides clear symptoms, skip to Step 1.3.

### Step 1.3: Document Observed Symptoms

Create a symptoms summary:

```markdown
## Observed Symptoms

| # | Symptom | Affected Area | Severity |
|---|---------|---------------|----------|
| 1 | Login returns 500 error | US1 - Authentication | Critical |
| 2 | Dashboard shows empty data | US2 - Data Display | High |
| 3 | Export button does nothing | US3 - Export | Medium |

**User's Description**: {verbatim from user input}
```

---

## Phase 2: Diagnostic Analysis

### Step 2.1: Spec vs Implementation Comparison

For each user story in spec.md, analyze:

```markdown
## US1: User Authentication

### Spec Requirements:
- [ ] User can login with email/password
- [ ] Invalid credentials show error message
- [ ] Successful login redirects to dashboard

### Implementation Check:

| Requirement | Implemented? | Location | Status |
|-------------|--------------|----------|--------|
| Login endpoint | ‚úÖ Yes | api/auth.py:45 | Working |
| Credential validation | ‚úÖ Yes | api/auth.py:52 | **BUGGY** |
| Error message display | ‚ùå No | - | Missing |
| Dashboard redirect | ‚úÖ Yes | frontend/Login.tsx:30 | Working |

### Gaps Found:
1. **BUG**: Credential validation throws exception instead of returning error
2. **MISSING**: Error message component not implemented
```

### Step 2.2: Task Completion vs Actual Results

Compare tasks.md with task-results/:

```markdown
## Task Completion Analysis

| Task | Marked | Result File | Actual Status |
|------|--------|-------------|---------------|
| T001 | [X] | T001-result.md | ‚úÖ Complete |
| T002 | [X] | T002-result.md | ‚ö†Ô∏è Partial - see deviations |
| T003 | [X] | T003-result.md | ‚ùå Claims complete but broken |
| T004 | [ ] | - | Not started |

### Deviation Analysis:

**T002 - Auth endpoint**:
- Planned: Full validation with error messages
- Actual: Basic validation only, error handling TODO noted
- Impact: Causes symptom #1 (500 error)

**T003 - Dashboard component**:
- Planned: Display user data with loading state
- Actual: Component exists but API call missing
- Impact: Causes symptom #2 (empty data)
```

### Step 2.3: Root Cause Classification

Based on analysis, classify each issue:

```markdown
## Root Cause Analysis

| Symptom | Category | Root Cause | Confidence |
|---------|----------|------------|------------|
| Login 500 error | **Implementation Bug** | Exception not caught in auth.py:52 | High |
| Empty dashboard | **Implementation Bug** | API call missing in Dashboard.tsx | High |
| Export button | **Spec Gap** | Export flow not specified | Medium |

### Summary:
- **Implementation Bugs**: 2 (fixable with code changes)
- **Spec Gaps**: 1 (needs spec clarification first)
- **Misunderstandings**: 0
- **Integration Issues**: 0
```

---

## Phase 3: Impact Assessment

### Step 3.1: Blast Radius Analysis

Determine what needs to change:

```markdown
## Change Impact

### Files Requiring Fixes:

| File | Changes Needed | Risk | Dependencies |
|------|----------------|------|--------------|
| api/auth.py | Add error handling | Low | None |
| frontend/Dashboard.tsx | Add API call | Low | Requires auth fix first |
| spec.md | Add export section | Medium | Needs user input |

### Dependency Order:
1. Fix auth.py (blocks Dashboard fix)
2. Fix Dashboard.tsx
3. Clarify export spec (independent)

### Estimated Effort:
- Code fixes: ~2 tasks
- Spec clarification: 1 session
- Re-validation: Required after fixes
```

### Step 3.2: Risk Assessment

```markdown
## Risk Assessment

| Fix | Risk Level | Mitigation |
|-----|------------|------------|
| Auth error handling | Low | Unit test exists, add edge case |
| Dashboard API call | Low | Follow existing pattern from other components |
| Export spec update | Medium | May require additional implementation tasks |

**Overall Risk**: Low - Changes are isolated and testable
```

---

## Phase 4: Correction Plan Generation

### Step 4.1: Generate Fix Tasks

Create targeted correction tasks:

```markdown
## Correction Tasks

### Immediate Fixes (Implementation Bugs)

These fix code that doesn't match the spec:

- [ ] FIX-001 [CRITICAL] Add try-catch error handling in api/auth.py:52
  > **Symptom**: Login returns 500 error
  > **Spec Reference**: US1 - "Invalid credentials show error message"
  > **Fix**: Wrap validation in try-catch, return 401 with message

- [ ] FIX-002 [HIGH] Add API call to Dashboard.tsx component
  > **Symptom**: Dashboard shows empty data
  > **Spec Reference**: US2 - "User sees their data on dashboard"
  > **Fix**: Add useEffect to fetch /api/user/data on mount
  > **Depends on**: FIX-001 (needs auth working)

### Spec Clarifications Needed

These require spec updates before implementation:

- [ ] CLARIFY-001 [MEDIUM] Define export functionality in spec.md
  > **Symptom**: Export button does nothing
  > **Gap**: No acceptance criteria for export
  > **Questions**:
  >   - What format? (CSV, PDF, JSON)
  >   - What data to export?
  >   - Where does file go? (download, email, storage)
```

### Step 4.2: Determine Action Path

Based on the correction plan:

```markdown
## Recommended Action Path

### Path A: Code Fixes Only (No spec changes needed)
If all issues are implementation bugs:
1. Execute FIX tasks immediately
2. Re-validate after fixes
3. Mark original tasks as truly complete

### Path B: Spec Clarification Required
If spec gaps exist:
1. First: Run `/speckit.clarify` with identified gaps
2. Then: Generate new tasks for clarified requirements
3. Then: Execute all FIX tasks
4. Finally: Re-validate

### Path C: Major Misunderstanding
If wrong feature was built:
1. Review original idea.md
2. Decide: Salvage or restart?
3. If salvage: Update spec with corrections
4. If restart: Archive current, run `/speckit.specify` fresh

**For This Feature**: Recommend **Path B**
- 2 code fixes can proceed immediately
- 1 spec clarification needed for export
```

---

## Phase 5: Update Artifacts

### Step 5.1: Update tasks.md with Fix Tasks

Find the highest task number and add fix tasks:

```markdown
### Bug Fixes (Added {date})

> **Source**: Fix analysis for {feature-name}
> **Root Cause**: Implementation bugs + spec gap
> **Priority**: Complete before continuing development

- [ ] FIX-001 [CRITICAL] Add error handling to auth endpoint in api/auth.py:52
- [ ] FIX-002 [HIGH] Add data fetch to Dashboard in frontend/Dashboard.tsx
  > Depends on: FIX-001

### Pending Spec Clarification

> **Blocker**: Cannot implement until spec is clarified

- [ ] CLARIFY-001 [MEDIUM] Define export requirements ‚Üí then generate export tasks
```

### Step 5.2: Mark Affected Tasks as Needs Fix

If original tasks were marked complete but are broken:

```markdown
# Update in tasks.md:

# Before:
- [X] T003 Implement Dashboard component [üìä Result](task-results/T003-result.md)

# After:
- [~] T003 Implement Dashboard component [üìä Result](task-results/T003-result.md) ‚ö†Ô∏è Needs FIX-002
```

### Step 5.3: Create Fix Analysis Report

Save to `FEATURE_DIR/fix-analysis-{date}.md`:

```markdown
# Fix Analysis Report

**Date**: {current_date}
**Feature**: {feature-name}
**Analyst**: Claude (speckit.fix)

## Executive Summary

- **Issues Found**: 3
- **Implementation Bugs**: 2 (fixable)
- **Spec Gaps**: 1 (needs clarification)
- **Estimated Fix Effort**: Low

## Symptoms Analyzed

{symptoms table}

## Root Causes Identified

{root cause analysis}

## Correction Plan

{fix tasks}

## Recommended Path

{action path recommendation}

## Files to Modify

{file list with changes}
```

---

## Phase 6: Execute or Handoff

### Option A: Execute Immediate Fixes

If user wants to proceed with code fixes:

1. **For each FIX task**, use Task tool with appropriate agent:

```yaml
Task:
  subagent_type: "backend-coder"  # or frontend-coder based on file
  prompt: |
    ## Fix Task: FIX-001

    **Problem**: Login returns 500 error instead of 401 with message
    **File**: api/auth.py:52
    **Spec Requirement**: US1 - "Invalid credentials show error message"

    ## Current Code Issue
    {relevant code snippet showing the bug}

    ## Expected Behavior
    - Invalid credentials should return 401 status
    - Response body should contain {"error": "Invalid credentials"}
    - No exceptions should propagate to client

    ## Fix Instructions
    1. Wrap credential validation in try-catch
    2. Catch ValidationError, return 401 with message
    3. Add unit test for invalid credentials case

    Report: files modified, test results, any complications
```

2. **After each fix**, create result file and update tasks.md
3. **After all fixes**, run validation

### Option B: Handoff to Clarify

If spec gaps need resolution first:

```markdown
## Handoff to Clarify

The following spec gaps need clarification before implementation:

**CLARIFY-001: Export Functionality**

Questions to resolve:
1. What file format should export produce?
2. What data should be included in the export?
3. Should export be synchronous (download) or async (email)?

‚Üí Click [Clarify Spec] to resolve these gaps
```

### Option C: Handoff to Re-implement

If fixes are ready to execute:

```markdown
## Handoff to Implement

Correction tasks have been added to tasks.md:
- FIX-001: Auth error handling
- FIX-002: Dashboard API call

‚Üí Click [Re-implement] to execute these fixes
‚Üí After fixes, click [Validate Fixes] to verify
```

---

## Output

Present to user:

```markdown
## Fix Analysis Complete

### Problem Summary

| Category | Count | Action |
|----------|-------|--------|
| Implementation Bugs | 2 | Fix immediately |
| Spec Gaps | 1 | Clarify first |
| Misunderstandings | 0 | - |

### Correction Tasks Created

**Immediate Fixes**:
- FIX-001: Add error handling to auth endpoint (CRITICAL)
- FIX-002: Add data fetch to Dashboard (HIGH)

**Needs Clarification**:
- CLARIFY-001: Define export requirements

### Recommended Path

**Path B: Spec Clarification Required**
1. Clarify export spec with user
2. Execute FIX-001 and FIX-002
3. Generate export tasks after clarification
4. Re-validate entire feature

### Files Generated

- `fix-analysis-{date}.md` - Full analysis report
- `tasks.md` - Updated with fix tasks

### Next Steps

Choose an action:
- [Execute Fixes] ‚Üí Fix the implementation bugs now
- [Clarify Spec] ‚Üí Resolve spec gaps first
- [View Report] ‚Üí Open full analysis report
```

---

## Quick Fix Mode

If user provides specific file/line:

```text
/speckit.fix api/auth.py:52 returns 500 instead of 401
```

Skip to targeted fix:

1. Read the file and surrounding context
2. Identify the specific bug
3. Generate single FIX task
4. Offer to fix immediately

---

## Integration with Other Commands

| Scenario | Command Flow |
|----------|--------------|
| Spec was wrong | `/speckit.fix` ‚Üí `/speckit.clarify` ‚Üí `/speckit.tasks` ‚Üí `/speckit.implement` |
| Code bug | `/speckit.fix` ‚Üí `/speckit.implement` (fix tasks only) |
| Need more info | `/speckit.fix` ‚Üí `/speckit.validate` (gather evidence) ‚Üí `/speckit.fix` again |
| Complete redo | `/speckit.fix` ‚Üí `/speckit.specify` (fresh start) |
