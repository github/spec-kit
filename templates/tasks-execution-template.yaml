# tasks.execution.yaml - Machine-readable manifest for parallel subagent orchestration
# Generated by /speckit.tasks for use with /speckit.implement
#
# This template shows the structure. The /speckit.tasks command MUST replace
# all placeholder values with actual data from the feature specification.

version: "1.0"
feature: "[FEATURE-NAME]"
generated: "[ISO-8601-TIMESTAMP]"

# =============================================================================
# EXECUTION CONSTRAINTS
# =============================================================================
execution_constraints:
  # Model Configuration (always use latest/best)
  model: opus-4.5                        # Most capable model

  # Parallelism
  max_parallel_subagents: 10             # Claude Code hard cap
  cross_phase_parallelism: true          # Independent stories run concurrently
  greedy_refill: true                    # Start queued task when slot frees

  # Timeouts
  default_task_timeout_seconds: 600      # 10min for complex tasks
  gate_timeout_seconds: 120              # 2min for validation
  subagent_timeout_seconds: 900          # 15min max per subagent

  # Dispatch Strategy
  dispatch_strategy: greedy_queue        # Launch up to max, queue overflow

  # Async/Background (v2.0.60+)
  async_background:
    enabled: true
    background_research_tasks: true      # Auto-background exploration tasks
    wake_on_complete: true               # Agents wake parent when done

  # Extended Thinking
  extended_thinking:
    enabled: true
    ultrathink_for: [architecture, design, complex_logic, security]

  # Fault Tolerance
  retry_policy:
    max_attempts: 3
    strategy: exponential                # exponential, linear, constant
    initial_delay_seconds: 5
    max_delay_seconds: 60
    retry_on: [timeout, rate_limit]
    fail_fast_on: [syntax_error, import_error, type_error]

  circuit_breaker:
    - at_failures: 3
      action: pause_batch                # Stop current batch, ask user
    - at_failures: 5
      action: pause_phase                # Stop entire phase
    - at_failures: 10
      action: abort                      # Stop everything

  # Context
  context_per_subagent: 200k             # Full 200k window per agent

# =============================================================================
# SHARED WORKSPACE (for inter-agent communication)
# =============================================================================
workspace:
  path: .claude/workspace
  context_file: context.md               # Shared context written by parent
  results_dir: results                   # Task completion summaries
  gates_dir: gates                       # Gate validation logs

# =============================================================================
# PHASES
# =============================================================================
phases:
  # ---------------------------------------------------------------------------
  # PHASE 1: SETUP
  # ---------------------------------------------------------------------------
  - id: phase-1
    name: Setup
    description: Project initialization and basic structure
    depends_on: []
    batches:
      - id: "1.1"
        parallel: true
        tasks:
          - id: T001
            description: "Create project structure per implementation plan"
            output_file: null            # Multiple files/dirs
            context_scope:
              - plan.md
            timeout_seconds: 300
          - id: T002
            description: "Initialize project with dependencies"
            output_file: pyproject.toml  # Or package.json, etc.
            context_scope:
              - plan.md#dependencies
            timeout_seconds: 180
          - id: T003
            description: "Configure linting and formatting tools"
            output_file: null
            context_scope:
              - plan.md#tooling
            timeout_seconds: 180
        gate:
          command: "test -f pyproject.toml && test -d src"
          on_fail:
            message: "Project structure incomplete"
            hints:
              - "Verify plan.md project structure section"
              - "Check that src/ directory was created"

  # ---------------------------------------------------------------------------
  # PHASE 2: FOUNDATIONAL
  # ---------------------------------------------------------------------------
  - id: phase-2
    name: Foundational
    description: Core infrastructure blocking all user stories
    depends_on: [phase-1]
    batches:
      - id: "2.1"
        parallel: true
        tasks:
          - id: T004
            description: "Setup database schema and migrations"
            output_file: src/db/schema.py
            context_scope:
              - plan.md#database
              - data-model.md
            timeout_seconds: 300
          - id: T005
            description: "Implement authentication framework"
            output_file: src/auth/auth.py
            context_scope:
              - plan.md#auth
              - research.md#auth-decisions
            timeout_seconds: 300
        gate:
          command: "ty src/db/*.py src/auth/*.py"
          on_fail:
            message: "Foundational type check failed"
            hints:
              - "Check data-model.md entity definitions"
              - "Verify auth framework imports"

      - id: "2.2"
        parallel: true
        depends_on: ["2.1"]
        tasks:
          - id: T006
            description: "Setup API routing and middleware"
            output_file: src/api/routes.py
            context_scope:
              - plan.md#api
              - src/auth/auth.py
            timeout_seconds: 300
          - id: T007
            description: "Configure error handling and logging"
            output_file: src/core/errors.py
            context_scope:
              - plan.md#error-handling
            timeout_seconds: 180
        gate:
          command: "ty src/api/*.py src/core/*.py && python -c 'from src.api.routes import router'"
          on_fail:
            message: "API setup failed"
            hints:
              - "Verify router exports correctly"
              - "Check middleware chain"

  # ---------------------------------------------------------------------------
  # PHASE 3: USER STORY 1 (replace with actual story from spec.md)
  # ---------------------------------------------------------------------------
  - id: phase-3
    name: "User Story 1 - [TITLE FROM SPEC.MD]"
    description: "[GOAL FROM SPEC.MD]"
    depends_on: [phase-2]
    priority: P1
    batches:
      - id: "3.1"
        parallel: true
        tasks:
          - id: T012
            description: "Create [Entity1] model in src/models/entity1.py"
            output_file: src/models/entity1.py
            context_scope:
              - plan.md#models
              - data-model.md#Entity1
            timeout_seconds: 300
          - id: T013
            description: "Create [Entity2] model in src/models/entity2.py"
            output_file: src/models/entity2.py
            context_scope:
              - plan.md#models
              - data-model.md#Entity2
            timeout_seconds: 300
        gate:
          command: "ty src/models/*.py && python -c 'from src.models import Entity1, Entity2'"
          on_fail:
            message: "Model type check failed"
            hints:
              - "Check data-model.md entity definitions match code"
              - "Verify all required fields are present"
              - pattern: "Cannot find module"
                hint: "Install missing dependency"
              - pattern: "Property .* does not exist"
                hint: "Field name mismatch with data-model.md"

      - id: "3.2"
        parallel: true
        depends_on: ["3.1"]
        tasks:
          - id: T014
            description: "Implement [Service] in src/services/service.py"
            output_file: src/services/service.py
            context_scope:
              - plan.md#services
              - src/models/entity1.py
              - src/models/entity2.py
              - contracts/endpoint.yaml
            timeout_seconds: 300
        gate:
          command: "ty src/services/*.py && python -c 'from src.services.service import Service'"
          on_fail:
            message: "Service implementation failed"
            hints:
              - "Verify model imports are correct"
              - "Check contracts/endpoint.yaml for interface spec"

      - id: "3.3"
        parallel: true
        depends_on: ["3.2"]
        tasks:
          - id: T015
            description: "Implement [endpoint] in src/api/endpoint.py"
            output_file: src/api/endpoint.py
            context_scope:
              - plan.md#endpoints
              - src/services/service.py
              - contracts/endpoint.yaml
            timeout_seconds: 300
        gate:
          command: "ty src/api/*.py && python -c 'from src.api.endpoint import router'"
          on_fail:
            message: "Endpoint implementation failed"
            hints:
              - "Verify service is importable"
              - "Check route registration"

  # ---------------------------------------------------------------------------
  # PHASE 4+: Additional user stories (follow same pattern)
  # ---------------------------------------------------------------------------
  # Copy phase-3 structure for each additional user story from spec.md
  # Adjust phase-id, name, tasks, and dependencies accordingly

  # ---------------------------------------------------------------------------
  # FINAL PHASE: POLISH
  # ---------------------------------------------------------------------------
  - id: phase-n
    name: Polish
    description: Cross-cutting improvements and documentation
    depends_on: [phase-3]  # Update to depend on all user story phases
    batches:
      - id: "n.1"
        parallel: true
        tasks:
          - id: TXXX
            description: "Update documentation in docs/"
            output_file: null
            context_scope:
              - plan.md
              - spec.md
            timeout_seconds: 300
          - id: TXXY
            description: "Run quickstart.md validation"
            output_file: null
            context_scope:
              - quickstart.md
            timeout_seconds: 300
        gate:
          command: "test -f docs/README.md"
          on_fail:
            message: "Documentation incomplete"
            hints:
              - "Ensure docs/ directory has required files"

# =============================================================================
# DEPENDENCY GRAPH
# =============================================================================
dependency_graph:
  edges:
    # Phase dependencies
    - from: phase-2
      to: phase-1
      type: phase_dependency
    - from: phase-3
      to: phase-2
      type: phase_dependency
    # Task dependencies (examples - generate from actual tasks)
    - from: T014
      to: T012
      type: imports
    - from: T014
      to: T013
      type: imports
    - from: T015
      to: T014
      type: uses

# =============================================================================
# ANALYSIS
# =============================================================================
critical_path:
  tasks: [T001, T004, T012, T014, T015]  # Replace with actual critical path
  length: 5

parallelism_analysis:
  total_tasks: 15                        # Replace with actual count
  critical_path_length: 5
  parallelism_factor: 3.0                # total_tasks / critical_path_length
  max_concurrent_subagents: 10
  max_parallelism_by_phase:
    phase-1: 3
    phase-2: 2
    phase-3: 2
    phase-n: 2
